Quick Stock Update & Monitoring Script: Copy-paste this full script into server/update-stock.js in Replit. Run node server/update-stock.js to update rolls (29 end last + 40 purchase = 69 current), query meat/drinks from DB (last form values), validate against POS usage from receipts (flags if anomalies), and log recommendations (e.g., low stock order suggestions). Proactive: Added auto-calc usage from today's receipts, variance flags (>10% = security alert in log), and table output for monitoring.

typescript

Collapse

Unwrap

Run

Copy
import { db } from '../db';
import { dailyStockSales, loyverseReceipts, recipes, recipeIngredients, inventory } from '../../shared/schema';
import { eq, desc } from 'drizzle-orm';
import { DateTime } from 'luxon';
import winston from 'winston';

const logger = winston.createLogger({ transports: [new winston.transports.Console(), new winston.transports.File({ filename: 'logs/stock-monitor.log' })] });

async function monitorStock() {
  const today = DateTime.now().setZone('Asia/Bangkok').toISODate();
  const lastShiftDate = DateTime.now().setZone('Asia/Bangkok').minus({ days: 1 }).toISODate();

  // Step 1: Get last shift form for ending stock
  const lastForm = await db.select().from(dailyStockSales).where(eq(dailyStockSales.shiftDate, lastShiftDate)).orderBy(desc(dailyStockSales.createdAt)).limit(1);
  if (!lastForm.length) {
    logger.warn('No last shift form - using defaults');
    return { success: false, message: 'No last form' };
  }
  const last = lastForm[0];
  const lastRolls = last.burgerBunsStock || 0;
  const lastMeat = last.meatWeight || 0;
  const lastDrinks = last.drinkStockCount || 0;

  // Step 2: Update with today's purchases (hardcoded for now - extend to expenses table query)
  const purchaseRolls = 40; // From user
  const purchaseMeat = 0; // Assume 0 - query stock_purchase_meat if purchases today
  const purchaseDrinks = 0; // Assume 0

  // Step 3: Calc today's usage from receipts
  const receipts = await db.select().from(loyverseReceipts).where(eq(loyverseReceipts.shiftDate, today));
  let usedRolls = 0;
  let usedMeat = 0;
  let usedDrinks = 0;
  for (const receipt of receipts) {
    for (const item of receipt.items as any[]) {
      if (item.item_name.includes('Burger')) {
        const recipe = await db.select().from(recipes).where(eq(recipes.name, item.item_name)).limit(1);
        if (recipe.length) {
          const ings = await db.select().from(recipeIngredients).where(eq(recipeIngredients.recipeId, recipe[0].id));
          for (const ing of ings) {
            if (ing.ingredientId === 'buns') usedRolls += (ing.quantity * item.quantity);
            if (ing.ingredientId === 'meat') usedMeat += (ing.quantity * item.quantity);
          }
        }
      }
      if (item.item_name.includes('Drink')) usedDrinks += item.quantity;
    }
  }

  // Step 4: Current stock = last end + purchase - today's usage
  const currentRolls = lastRolls + purchaseRolls - usedRolls;
  const currentMeat = lastMeat + purchaseMeat - usedMeat;
  const currentDrinks = lastDrinks + purchaseDrinks - usedDrinks;

  // Step 5: Update inventory table (proactive - assume table has rows for 'rolls', 'meat', 'drinks')
  await db.update(inventory).set({ quantity: currentRolls }).where(eq(inventory.name, 'Burger Rolls'));
  await db.update(inventory).set({ quantity: currentMeat }).where(eq(inventory.name, 'Meat'));
  await db.update(inventory).set({ quantity: currentDrinks }).where(eq(inventory.name, 'Drinks'));

  // Step 6: Flags & suggestions
  const flags = [];
  const orders = [];
  if (usedRolls > lastRolls * 1.1) flags.push(`Security: Rolls used ${usedRolls} > last stock ${lastRolls}`);
  if (currentRolls < 50) orders.push(`Order rolls: 40 more (current ${currentRolls})`);
  if (usedMeat > lastMeat * 1.1) flags.push(`Security: Meat used ${usedMeat} > last stock ${lastMeat}`);
  if (currentMeat < 10) orders.push(`Order meat: 20kg more (current ${currentMeat})`);
  if (usedDrinks > lastDrinks * 1.1) flags.push(`Security: Drinks used ${usedDrinks} > last stock ${lastDrinks}`);
  if (currentDrinks < 50) orders.push(`Order drinks: 100 more (current ${currentDrinks})`);

  // Output tables
  console.table({ CurrentStock: { Rolls: currentRolls, Meat: currentMeat, Drinks: currentDrinks } });
  console.table({ Flags: flags });
  console.table({ OrderSuggestions: orders });
  logger.info(`Monitored stock: Rolls ${currentRolls}, Meat ${currentMeat}, Drinks ${currentDrinks}`);

  return { current: { rolls: currentRolls, meat: currentMeat, drinks: currentDrinks }, flags, orders };
}

monitorStock();
Run & Output Example: Table for current (Rolls: 69 - used, etc.), flags (if usage > last), orders (if low).

Proactive: Script updates inventory table automatically. Extend to query purchases from stock_purchase_* tables for meat/drinks today (automation - no manual).

Optimization: Add to orchestrator processShiftData for auto-run post-shift: await monitorStock();.

Anticipated: If no today's receipts, usage = 0. If purchase data in expenses, query/add. Low thresholds adjustable (50 rolls, 10kg meat, 50 drinks).

Run script nowâ€”share tables/output. If errors (e.g., no form), sync/pull data first.