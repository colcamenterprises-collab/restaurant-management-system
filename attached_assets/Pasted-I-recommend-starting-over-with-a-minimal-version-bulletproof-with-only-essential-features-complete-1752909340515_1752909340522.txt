I recommend starting over with a minimal version—bulletproof, with only essential features: complete/save, email on submit, view past forms, draft save. This aligns with Replit's backend (Express for API, Drizzle for DB, Nodemailer for email—direct Gmail API).

The instructions are self-contained so you can copy-paste them to the Replit agent or implement yourself. Focus on direct API, no 3rd party tools. Assume your current stack (React frontend, Express backend, PostgreSQL/Drizzle DB).

Step 1: Review the Existing Form (Diagnose Issues)
Check Frontend (client/src/pages/DailyStockSales.tsx):
Open the file.
Look for useForm from react-hook-form and zodResolver. Check if schema requires fields (min(1))—this can cause validation errors if blanks allowed.
Inspect onSubmit: Ensure it sends POST to /api/daily-stock-sales with JSON data.
Test in browser: F12 > Console/Network tab, submit form, note errors (e.g., "Expected number").
Check Backend (server/routes.ts or server/storage.ts):
Find POST /api/daily-stock-sales.
Check for transaction (db.transaction) to save form data to daily_stock_sales.
Look for email trigger (sendManagementSummary) after save.
Test with curl:
bash

Collapse

Unwrap

Run

Copy
curl -X POST http://localhost:5000/api/daily-stock-sales -H "Content-Type: application/json" -d '{"completedBy": "Test", "shiftType": "closing", "shiftDate": "2025-07-18T00:00:00Z", "grabSales": 1500, "totalSales": 1500, "isDraft": true}'
If 500 error, check Replit console for logs (e.g., DB insert fail, email error).
Check DB Schema (shared/schema.ts):
Ensure daily_stock_sales has optional fields (e.g., grabSales: decimal('grab_sales').default(0)).
Run npx drizzle-kit migrate if needed.
Common Fixes:
If 500 from DB: Add defaults in Zod schema (z.number().optional().default(0)).
If email fails: Verify GMAIL_USER/PASS in .env, enable "Less secure app access" in Gmail.
If review shows complex logic (e.g., too many auto-calcs causing breaks), start over (recommended for bulletproof).

Step 2: Fix Existing Form (If Review Shows Minor Issues)
Frontend Patch (DailyStockSales.tsx - Add to useForm): Make fields optional/default 0.
typescript

Collapse

Unwrap

Run

Copy
const formSchema = z.object({
  completedBy: z.string().min(1),
  shiftType: z.enum(['opening', 'closing']),
  shiftDate: z.string().datetime(),
  grabSales: z.coerce.number().optional().default(0),
  // ... all numeric fields optional default 0
  isDraft: z.boolean().optional(),
});
Backend Patch (routes.ts - POST /api/daily-stock-sales): Add transaction, email on non-draft.
typescript

Collapse

Unwrap

Run

Copy
app.post("/api/daily-stock-sales", async (req, res) => {
  try {
    const data = req.body;
    let result;
    await db.transaction(async (tx) => {
      [result] = await tx.insert(dailyStockSales).values(data).returning();
    });
    res.json(result);

    if (!data.isDraft) {
      sendManagementSummary({ formData: result }); // Your email function
    }
  } catch (err) {
    res.status(500).json({ error: "Save failed" });
  }
});
Test: Submit draft (isDraft true)—save without email. Submit full—save + email.
Step 3: Start Over with Minimal Form (Recommended for Bulletproof)
If fix fails, replace with this simple version. Frontend: Basic form with save/draft. Backend: Save to DB, email on submit.

Frontend (client/src/pages/DailyStockSales.tsx - Full Replacement)
tsx

Collapse

Unwrap

Copy
import { useForm } from 'react-hook-form';
import { z } from 'zod';
import { zodResolver } from '@hookform/resolvers/zod';
import { Button, Input, Card, CardHeader, CardContent } from "@/components/ui";

const formSchema = z.object({
  completedBy: z.string().min(1, "Required"),
  shiftType: z.enum(['opening', 'closing']),
  shiftDate: z.string().datetime("Required"),
  grabSales: z.coerce.number().optional().default(0),
  // Add all fields as optional default 0 for numbers, required for key
  burgerBunsStock: z.coerce.number().optional().default(0),
  meatWeight: z.coerce.number().optional().default(0),
  drinkStockCount: z.coerce.number().optional().default(0),
  freshFood: z.array(z.object({ name: z.string(), value: z.coerce.number().optional().default(0) })).optional(),
  // ...other arrays
  isDraft: z.boolean().optional().default(false),
});

const DailyStockSales = () => {
  const form = useForm({ resolver: zodResolver(formSchema) });
  const onSubmit = async (data) => {
    const response = await fetch('/api/daily-stock-sales', { method: 'POST', body: JSON.stringify(data), headers: {'Content-Type': 'application/json'} });
    if (response.ok) {
      console.log('Saved!');
    } else {
      console.error('Error');
    }
  };

  return (
    <Card>
      <CardHeader>Sales and Stock Form</CardHeader>
      <CardContent>
        <form onSubmit={form.handleSubmit(onSubmit)}>
          <Input placeholder="Completed By" {...form.register("completedBy")} />
          // Add all inputs...
          <Button type="submit">Save</Button>
          <Button type="submit" onClick={() => form.setValue('isDraft', true)}>Save Draft</Button>
        </form>
      </CardContent>
    </Card>
  );
};
Backend (server/routes.ts - POST /api/daily-stock-sales)
typescript

Collapse

Unwrap

Run

Copy
app.post("/api/daily-stock-sales", async (req, res) => {
  try {
    const data = req.body;
    let result;
    await db.transaction(async (tx) => {
      [result] = await tx.insert(dailyStockSales).values(data).returning();
    });
    res.json(result);

    if (!data.isDraft) {
      sendManagementSummary({ formData: result }); // Your email function
    }
  } catch (err) {
    res.status(500).json({ error: "Save failed" });
  }
});

app.get("/api/daily-stock-sales", async (req, res) => {
  const forms = await db.select().from(dailyStockSales).orderBy(desc(dailyStockSales.shiftDate));
  res.json(forms);
});
Email Function (server/gmailService.js - Ensure Working)
Confirm GMAIL_USER/PASS in .env.
View Past Forms (New Page client/src/pages/PastForms.tsx)
tsx

Collapse

Unwrap

Copy
import { useEffect, useState } from 'react';
import { Card, CardHeader, CardContent, Table, TableBody, TableRow, TableCell } from "@/components/ui";

const PastForms = () => {
  const [forms, setForms] = useState([]);

  useEffect(() => {
    fetch('/api/daily-stock-sales').then(r => r.json()).then(setForms);
  }, []);

  return (
    <Card>
      <CardHeader>Past Forms</CardHeader>
      <CardContent>
        <Table>
          <TableBody>
            {forms.map(f => <TableRow key={f.id}><TableCell>{f.shiftDate}</TableCell><TableCell>{f.completedBy}</TableCell><TableCell>{f.isDraft ? 'Draft' : 'Complete'}</TableCell></TableRow>)}
          </TableBody>
        </Table>
      </CardContent>
    </Card>
  );
};
Bulletproof Tips: Use transactions for saves, Zod for validation, defaults for blanks. No auto-calcs if causing breaks.
Test submit—share error if 500. If start over, replace files.