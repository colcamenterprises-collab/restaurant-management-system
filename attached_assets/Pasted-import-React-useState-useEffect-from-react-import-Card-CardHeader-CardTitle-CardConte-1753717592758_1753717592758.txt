import React, { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { AlertTriangle, CheckCircle, Upload } from 'lucide-react';
import { Input } from '@/components/ui/input';
import { format } from 'date-fns';

const ShiftComparison = () => {
  const [shiftData, setShiftData] = useState(null);
  const [dailyData, setDailyData] = useState(null);
  const [comparison, setComparison] = useState(null);

  const handleFileUpload = (e, type) => {
    const reader = new FileReader();
    reader.onload = () => {
      const parsed = JSON.parse(reader.result);
      if (type === 'shift') setShiftData(parsed);
      else setDailyData(parsed);
    };
    reader.readAsText(e.target.files[0]);
  };

  useEffect(() => {
    if (shiftData && dailyData) {
      const result = compareReports(shiftData, dailyData);
      setComparison(result);
    }
  }, [shiftData, dailyData]);

  const compareReports = (shift, daily) => {
    const categories = ['grab_sales', 'qr_sales', 'aroi_sales', 'cash_sales', 'total_sales', 'register_balance'];
    const differences = categories.map(cat => {
      const shiftValue = Number(shift[cat] || 0);
      const dailyValue = Number(daily[cat] || 0);
      const diff = shiftValue - dailyValue;
      return {
        label: cat.replace('_', ' ').toUpperCase(),
        shift: shiftValue,
        daily: dailyValue,
        difference: diff,
        match: Math.abs(diff) <= 50 // allow 50 baht tolerance
      };
    });
    return differences;
  };

  return (
    <div className="max-w-4xl mx-auto p-4">
      <h1 className="text-2xl font-bold mb-4">üß† Jussi's Shift Integrity Checker</h1>

      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
        <Card>
          <CardHeader>
            <CardTitle>Upload POS Shift Report</CardTitle>
          </CardHeader>
          <CardContent>
            <Input type="file" accept="application/JSON" onChange={(e) => handleFileUpload(e, 'shift')} />
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Upload Daily Sales Form</CardTitle>
          </CardHeader>
          <CardContent>
            <Input type="file" accept="application/JSON" onChange={(e) => handleFileUpload(e, 'daily')} />
          </CardContent>
        </Card>
      </div>

      {comparison && (
        <Card className="border-green-600 shadow-md">
          <CardHeader>
            <CardTitle>üîç Shift Comparison Result</CardTitle>
          </CardHeader>
          <CardContent className="space-y-3">
            {comparison.map((item, idx) => (
              <div key={idx} className="flex justify-between border-b pb-1">
                <span className="font-semibold">{item.label}</span>
                <span>
                  POS: ‡∏ø{item.shift} | Manual: ‡∏ø{item.daily} {' '}
                  {item.match ? (
                    <CheckCircle className="inline h-4 w-4 text-green-500 ml-2" />
                  ) : (
                    <AlertTriangle className="inline h-4 w-4 text-red-500 ml-2" />
                  )}
                </span>
              </div>
            ))}
          </CardContent>
        </Card>
      )}
    </div>
  );
};

export default ShiftComparison;
