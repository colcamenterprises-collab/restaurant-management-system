the DB doesn’t have the columns/tables your Library route is querying, so Postgres dies with errorMissingColumn. Let’s fix it without touching any existing data.

Do exactly this

Open prisma/schema.prisma and append these additive models (new tables; won’t clash with your current ones):

model DailySalesV2 {
  id             String   @id @default(uuid())
  createdAt      DateTime @default(now())
  shiftDate      String
  submittedAtISO DateTime
  completedBy    String
  startingCash   Int      @default(0)
  endingCash     Int      @default(0)
  cashBanked     Int      @default(0)
  cashSales      Int      @default(0)
  qrSales        Int      @default(0)
  grabSales      Int      @default(0)
  aroiSales      Int      @default(0)
  totalSales     Int      @default(0)
  shoppingTotal  Int      @default(0)
  wagesTotal     Int      @default(0)
  othersTotal    Int      @default(0)
  totalExpenses  Int      @default(0)
  qrTransfer     Int      @default(0)
  shopping       ShoppingPurchaseV2[]
  wages          WageEntryV2[]
  others         OtherExpenseV2[]
  stock          DailyStockV2?
  deletedAt      DateTime?

  @@map("daily_sales_v2")
}

model ShoppingPurchaseV2 {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  item      String
  cost      Int      @default(0)
  shop      String
  salesId   String
  sales     DailySalesV2 @relation(fields: [salesId], references: [id], onDelete: Cascade)

  @@map("shopping_purchase_v2")
}

model WageEntryV2 {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  staff     String
  amount    Int      @default(0)
  type      String
  salesId   String
  sales     DailySalesV2 @relation(fields: [salesId], references: [id], onDelete: Cascade)

  @@map("wage_entry_v2")
}

model OtherExpenseV2 {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  label     String
  amount    Int      @default(0)
  salesId   String
  sales     DailySalesV2 @relation(fields: [salesId], references: [id], onDelete: Cascade)

  @@map("other_expense_v2")
}

model DailyStockV2 {
  id            String   @id @default(uuid())
  createdAt     DateTime @default(now())
  salesId       String   @unique
  sales         DailySalesV2 @relation(fields: [salesId], references: [id], onDelete: Cascade)
  burgerBuns    Int      @default(0)
  meatWeightG   Int      @default(0)
  drinksJson    Json?
  purchasingJson Json?
  notes         String?
  deletedAt     DateTime?

  @@map("daily_stock_v2")
}


Push the schema additively (no data loss):

npx prisma db push
npx prisma generate


Point the server to V2 models so Library/Forms use the new tables:

In server/routes/forms.ts:

dailySales → dailySalesV2

dailyStock → dailyStockV2

child shopping/wages/others → ShoppingPurchaseV2/WageEntryV2/OtherExpenseV2

Map Closing Cash → endingCash:

endingCash: Number(body.banking?.closingCash ?? 0),


In server/routes/library.ts:

Use db().dailySalesV2.findMany({ include: { stock: true } }), etc.

Keep the try/catch guard so schema issues don’t crash the app.

Smoke-test

Open /operations/daily-sales-library → should load (empty list is fine).

Submit Form 1 → you get a salesId.

(When you paste Form 2) submit → email/PDF → row appears in Library.

Quick checks if it still crashes

Confirm the tables exist:

SELECT to_regclass('public.daily_sales_v2');
SELECT to_regclass('public.daily_stock_v2');


If either returns NULL, step 2 didn’t run—run npx prisma db push again (watch for errors).

Add this tiny log in Library route to see the exact PG code:

} catch (e:any) { console.error("LIBRARY_ERR", e.code, e.message); /* ... */ }