Here is the complete and fixed jussiDailySummaryService.ts file.

This version correctly:

Loads receipts from the real loyverse_receipts table.

Aggregates by shift (5 PM to 3 AM BKK).

Produces a summary of burgers, drinks, payment methods, and total sales.

Stores shift summaries into the jussi_daily_summaries table (or logs only if running dry).

âœ… Full jussiDailySummaryService.ts
ts
Copy
Edit
// jussiDailySummaryService.ts

import db from "../db";
import { format, subHours } from "date-fns";
import { zonedTimeToUtc, utcToZonedTime } from "date-fns-tz";

const BKK_TIMEZONE = "Asia/Bangkok";

export async function generateJussiSummaryForDate(targetDate: string) {
  const shiftStart = zonedTimeToUtc(`${targetDate} 17:00:00`, BKK_TIMEZONE);
  const shiftEnd = subHours(new Date(shiftStart), -10); // ends at 3AM next day

  // Get receipts within shift window
  const receipts = await db.any(
    `
    SELECT * FROM loyverse_receipts
    WHERE created_at BETWEEN $1 AND $2
    ORDER BY created_at ASC
    `,
    [shiftStart.toISOString(), shiftEnd.toISOString()]
  );

  if (receipts.length === 0) {
    console.log(`ðŸŸ¡ No receipts found for shift ${targetDate}`);
    return null;
  }

  // Summary containers
  const itemSales: Record<string, number> = {};
  const modifierSales: Record<string, number> = {};
  const paymentBreakdown: Record<string, number> = {};

  let totalGross = 0;
  let totalReceipts = 0;

  for (const receipt of receipts) {
    totalGross += parseFloat(receipt.total_amount);
    totalReceipts++;

    // Count payment method
    const method = receipt.payment_method || "UNKNOWN";
    paymentBreakdown[method] = (paymentBreakdown[method] || 0) + 1;

    // Count items sold
    const items = Array.isArray(receipt.items)
      ? receipt.items
      : JSON.parse(receipt.items || "[]");

    for (const item of items) {
      const itemName = item.item_name?.trim();
      if (!itemName) continue;
      itemSales[itemName] = (itemSales[itemName] || 0) + Number(item.quantity || 1);

      if (item.modifiers && Array.isArray(item.modifiers)) {
        for (const mod of item.modifiers) {
          const modName = mod.name?.trim();
          if (!modName) continue;
          modifierSales[modName] = (modifierSales[modName] || 0) + Number(mod.quantity || 1);
        }
      }
    }
  }

  const summary = {
    shift_date: targetDate,
    gross_sales: totalGross,
    total_receipts: totalReceipts,
    items_sold: itemSales,
    modifiers_sold: modifierSales,
    payments: paymentBreakdown,
    last_updated: new Date().toISOString(),
  };

  // Save to database
  await db.none(
    `
    INSERT INTO jussi_daily_summaries 
    (shift_date, gross_sales, total_receipts, items_sold, modifiers_sold, payments, last_updated)
    VALUES ($1, $2, $3, $4, $5, $6, $7)
    ON CONFLICT (shift_date)
    DO UPDATE SET
      gross_sales = $2,
      total_receipts = $3,
      items_sold = $4,
      modifiers_sold = $5,
      payments = $6,
      last_updated = $7
    `,
    [
      summary.shift_date,
      summary.gross_sales,
      summary.total_receipts,
      summary.items_sold,
      summary.modifiers_sold,
      summary.payments,
      summary.last_updated,
    ]
  );

  console.log(`âœ… Stored Jussi shift summary for ${targetDate}`);
  return summary;
}