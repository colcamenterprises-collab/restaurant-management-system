Fixes & Enhancements
Fix Form Submit Error
Check for 500 errors (likely DB insert fail), add robust error handling.
View/Search/Download Completed Forms
Add GET endpoint to list/search forms, generate PDF download.
Retrieve/Edit Drafts
Add GET for drafts, allow edit/resubmit.
Updated Code
DB Schema (shared/schema.ts - Verify)

Ensure dailyStockSales has all fields, add status for draft/completed.
typescript

Collapse

Unwrap

Run

Copy
export const dailyStockSales = pgTable('daily_stock_sales', {
  id: serial('id').primaryKey(),
  completedBy: varchar('completedBy', { length: 255 }),
  shiftType: varchar('shiftType', { length: 50 }),
  shiftDate: timestamp('shiftDate'),
  grabSales: decimal('grabSales', { precision: 10, scale: 2 }).default(0),
  aroiDeeSales: decimal('aroiDeeSales', { precision: 10, scale: 2 }).default(0),
  qrScanSales: decimal('qrScanSales', { precision: 10, scale: 2 }).default(0),
  cashSales: decimal('cashSales', { precision: 10, scale: 2 }).default(0),
  totalSales: decimal('totalSales', { precision: 10, scale: 2 }).default(0),
  wages: jsonb('wages'),
  shopping: jsonb('shopping'),
  gasExpense: decimal('gasExpense', { precision: 10, scale: 2 }).default(0),
  totalExpenses: decimal('totalExpenses', { precision: 10, scale: 2 }).default(0),
  startingCash: decimal('startingCash', { precision: 10, scale: 2 }).default(0),
  endCash: decimal('endCash', { precision: 10, scale: 2 }).default(0),
  bankedAmount: decimal('bankedAmount', { precision: 10, scale: 2 }).default(0),
  burgerBunsStock: integer('burgerBunsStock').default(0),
  meatWeight: decimal('meatWeight', { precision: 10, scale: 2 }).default(0),
  drinkStockCount: integer('drinkStockCount').default(0),
  freshFood: jsonb('freshFood'),
  frozenFood: jsonb('frozenFood'),
  shelfItems: jsonb('shelfItems'),
  drinkStock: jsonb('drinkStock'),
  kitchenItems: jsonb('kitchenItems'),
  packagingItems: jsonb('packagingItems'),
  status: varchar('status', { length: 50 }).default('draft'), // draft/completed
  isDraft: boolean('isDraft').default(true),
  createdAt: timestamp('createdAt').defaultNow(),
});
Run npx drizzle-kit migrate.

Frontend Form (client/src/pages/DailyShiftForm.tsx - Replace Existing)

Add draft edit link, search completed.
tsx

Collapse

Unwrap

Copy
import { useForm } from 'react-hook-form';
import { z } from 'zod';
import { zodResolver } from '@hookform/resolvers/zod';
import { Input, Button, Card, CardHeader, CardContent, Label, Select } from "@/components/ui";
import { useState, useEffect } from 'react';
import jsPDF from 'jspdf';

const formSchema = z.object({
  completedBy: z.string().min(1, "Required"),
  shiftType: z.enum(['opening', 'closing']),
  shiftDate: z.string().datetime("Required"),
  grabSales: z.coerce.number().optional().default(0),
  aroiDeeSales: z.coerce.number().optional().default(0),
  qrScanSales: z.coerce.number().optional().default(0),
  cashSales: z.coerce.number().optional().default(0),
  totalSales: z.coerce.number().optional().default(0),
  wages: z.array(z.object({ staffName: z.string().min(1), amount: z.coerce.number().min(0).optional().default(0), type: z.enum(['wages', 'overtime', 'other']) })).optional().default([]),
  shopping: z.array(z.object({ item: z.string().min(1), amount: z.coerce.number().min(0).optional().default(0), shopName: z.string().optional() })).optional().default([]),
  gasExpense: z.coerce.number().optional().default(0),
  totalExpenses: z.coerce.number().optional().default(0),
  startingCash: z.coerce.number().optional().default(0),
  endCash: z.coerce.number().optional().default(0),
  bankedAmount: z.coerce.number().optional().default(0),
  burgerBunsStock: z.coerce.number().optional().default(0),
  meatWeight: z.coerce.number().optional().default(0),
  drinkStockCount: z.coerce.number().optional().default(0),
  freshFood: z.array(z.object({ name: z.string(), value: z.coerce.number().optional().default(0) })).optional().default([]),
  frozenFood: z.array(z.object({ name: z.string(), value: z.coerce.number().optional().default(0) })).optional().default([]),
  shelfItems: z.array(z.object({ name: z.string(), value: z.coerce.number().optional().default(0) })).optional().default([]),
  drinkStock: z.array(z.object({ name: z.string(), value: z.coerce.number().optional().default(0) })).optional().default([]),
  kitchenItems: z.array(z.object({ name: z.string(), value: z.coerce.number().optional().default(0) })).optional().default([]),
  packagingItems: z.array(z.object({ name: z.string(), value: z.coerce.number().optional().default(0) })).optional().default([]),
  isDraft: z.boolean().optional().default(false),
});

const DailyShiftForm = () => {
  const form = useForm({ resolver: zodResolver(formSchema), defaultValues: formSchema.parse({}) });
  const { watch, setValue, reset } = form;
  const [wagesEntries, setWagesEntries] = useState(1);
  const [shoppingEntries, setShoppingEntries] = useState(1);
  const [drafts, setDrafts] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState([]);

  useEffect(() => {
    const salesTotal = watch(['grabSales', 'aroiDeeSales', 'qrScanSales', 'cashSales']).reduce((sum, val) => sum + Number(val || 0), 0);
    setValue('totalSales', salesTotal);
    const wagesTotal = watch('wages').reduce((sum, w) => sum + Number(w.amount || 0), 0);
    const shoppingTotal = watch('shopping').reduce((sum, s) => sum + Number(w.amount || 0), 0);
    const expTotal = wagesTotal + shoppingTotal + Number(watch('gasExpense') || 0);
    setValue('totalExpenses', expTotal);
    fetch('/api/daily-stock-sales/drafts').then(r => r.json()).then(setDrafts);
  }, [watch, setValue]);

  const onSubmit = async (data) => {
    try {
      data.status = data.isDraft ? 'draft' : 'completed';
      const response = await fetch('/api/daily-stock-sales', { method: 'POST', body: JSON.stringify(data), headers: {'Content-Type': 'application/json'} });
      if (response.ok) {
        const result = await response.json();
        if (!data.isDraft) {
          const purchaseItems = [...data.freshFood, ...data.frozenFood, ...data.shelfItems, ...data.drinkStock, ...data.kitchenItems, ...data.packagingItems].filter(i => i.value > 0);
          const shoppingList = purchaseItems.map(i => ({ itemName: i.name, quantity: i.value, unit: i.unit || 'unit', formId: result.id, listDate: new Date(data.shiftDate) }));
          await fetch('/api/shopping-list/bulk', { method: 'POST', body: JSON.stringify(shoppingList) });
        }
        reset();
      } else {
        throw new Error('Submit failed');
      }
    } catch (err) {
      console.error(err);
    }
  };

  const loadDraft = (id) => {
    fetch(`/api/daily-stock-sales/${id}`).then(r => r.json()).then(data => {
      form.reset(data);
      setValue('isDraft', true);
    });
  };

  const searchForms = async () => {
    const response = await fetch(`/api/daily-stock-sales/search?query=${searchQuery}`);
    const results = await response.json();
    setSearchResults(results);
  };

  const downloadForm = (form) => {
    const doc = new jsPDF();
    doc.text(`Form ID: ${form.id}`, 10, 10);
    doc.text(`Date: ${form.shiftDate}`, 10, 20);
    doc.text(`Total Sales: ฿${form.totalSales}`, 10, 30);
    doc.save(`form_${form.id}.pdf`);
  };

  return (
    <Card>
      <CardHeader>Daily Sales & Stock Form</CardHeader>
      <CardContent>
        <form onSubmit={form.handleSubmit(onSubmit)}>
          <Label>Completed By*</Label>
          <Input {...form.register("completedBy")} />
          <Label>Shift Type</Label>
          <select {...form.register("shiftType")}>
            <option value="opening">Opening</option>
            <option value="closing">Closing</option>
          </select>
          <Label>Shift Date*</Label>
          <Input type="datetime-local" {...form.register("shiftDate")} />
          <Label>Starting Cash (฿)</Label>
          <Input type="number" {...form.register("startingCash")} />

          <h3>Sales Information</h3>
          <Label>Grab Sales (฿)</Label>
          <Input type="number" {...form.register("grabSales")} />
          <Label>Aroi Dee Sales (฿)</Label>
          <Input type="number" {...form.register("aroiDeeSales")} />
          <Label>QR Scan Sales (฿)</Label>
          <Input type="number" {...form.register("qrScanSales")} />
          <Label>Cash Sales (฿)</Label>
          <Input type="number" {...form.register("cashSales")} />
          <Label>Total Sales (฿)</Label>
          <Input disabled value={form.watch('totalSales')} />

          <h3>Expenses</h3>
          <Label>Wages</Label>
          {[...Array(wagesEntries)].map((_, i) => (
            <div key={i}>
              <Input placeholder="Staff Name" {...form.register(`wages.${i}.staffName`)} />
              <Input type="number" placeholder="Amount" {...form.register(`wages.${i}.amount`)} />
              <select {...form.register(`wages.${i}.type`)}>
                <option value="wages">Wages</option>
                <option value="overtime">Overtime</option>
                <option value="other">Other</option>
              </select>
            </div>
          ))}
          <Button type="button" onClick={() => setWagesEntries(wagesEntries + 1)}>Add Wage Entry</Button>

          <Label>Shopping</Label>
          {[...Array(shoppingEntries)].map((_, i) => (
            <div key={i}>
              <Input placeholder="Item Purchased" {...form.register(`shopping.${i}.item`)} />
              <Input type="number" placeholder="Amount" {...form.register(`shopping.${i}.amount`)} />
              <Input placeholder="Shop Name" {...form.register(`shopping.${i}.shopName`)} />
            </div>
          ))}
          <Button type="button" onClick={() => setShoppingEntries(shoppingEntries + 1)}>Add Shopping Entry</Button>

          <Label>Gas Expense (฿)</Label>
          <Input type="number" {...form.register("gasExpense")} />

          <Label>Total Expenses (฿)</Label>
          <Input disabled value={form.watch('totalExpenses')} />

          <h3>Summary</h3>
          <p>Total Sales: ฿{form.watch('totalSales')}</p>
          <p>Breakdown: Grab ฿{form.watch('grabSales')}, Aroi Dee ฿{form.watch('aroiDeeSales')}, QR ฿{form.watch('qrScanSales')}, Cash ฿{form.watch('cashSales')}</p>
          <p>Total Expenses: ฿{form.watch('totalExpenses')}</p>
          <p>Breakdown: Wages ฿{form.watch('wages').reduce((sum, w) => sum + Number(w.amount || 0), 0)}, Shopping ฿{form.watch('shopping').reduce((sum, s) => sum + Number(s.amount || 0), 0)}, Gas ฿{form.watch('gasExpense')}</p>
          <Label>Total Cash in Register at Closing (฿)</Label>
          <Input type="number" {...form.register("endCash")} />
          <Label>Amount to be Banked (฿)</Label>
          <Input type="number" {...form.register("bankedAmount")} />

          <h3>Stock and Produce</h3>
          <Label>Burger Buns Stock (In Hand)</Label>
          <Input type="number" {...form.register("burgerBunsStock")} />
          <Label>Meat Weight (In Hand, kg)</Label>
          <Input type="number" {...form.register("meatWeight")} />
          <Label>Drink Stock Count (In Hand)</Label>
          <Input type="number" {...form.register("drinkStockCount")} />
          <Label>Pickles</Label>
          <Input type="number" {...form.register("freshFood.0.value")} />
          <Label>French Fries</Label>
          <Input type="number" {...form.register("frozenFood.0.value")} />
          <Label>Nuggets</Label>
          <Input type="number" {...form.register("frozenFood.1.value")} />

          <Button type="submit">Save</Button>
          <Button type="submit" onClick={() => form.setValue('isDraft', true)}>Save Draft</Button>
        </form>
        <div>
          <Input placeholder="Search Forms" onChange={(e) => setSearchQuery(e.target.value)} />
          <Button onClick={searchForms}>Search</Button>
          {searchResults.map(form => (
            <div key={form.id}>
              <p>{form.shiftDate} by {form.completedBy}</p>
              <Button onClick={() => downloadForm(form)}>Download PDF</Button>
            </div>
          ))}
          <h4>Drafts</h4>
          {drafts.map(draft => (
            <Button key={draft.id} onClick={() => loadDraft(draft.id)}>Edit Draft {draft.id}</Button>
          ))}
        </div>
      </CardContent>
    </Card>
  );
};

export default DailyShiftForm;
Backend Routes (server/routes.ts - Update POST/GET)

Handle draft/completed, search, download.
typescript

Collapse

Unwrap

Run

Copy
import express from 'express';
import { db } from '../db';
import { dailyStockSales, shoppingList } from '../../shared/schema';
import { eq, desc, sql } from 'drizzle-orm';
import { DateTime } from 'luxon';
import jsPDF from 'jspdf';
import nodemailer from 'nodemailer';

const app = express();
app.use(express.json());

const transporter = nodemailer.createTransport({
  service: 'gmail',
  auth: { user: process.env.GMAIL_USER, pass: process.env.GMAIL_PASS },
});

app.post('/api/daily-stock-sales', async (req, res) => {
  try {
    const data = req.body;
    data.shiftDate = new Date(data.shiftDate);
    data.status = data.isDraft ? 'draft' : 'completed';
    const [result] = await db.transaction(async (tx) => {
      const [inserted] = await tx.insert(dailyStockSales).values(data).returning({ id: dailyStockSales.id });
      if (!data.isDraft) {
        const purchaseItems = [...(data.freshFood || []), ...(data.frozenFood || []), ...(data.shelfItems || []), ...(data.drinkStock || []), ...(data.kitchenItems || []), ...(data.packagingItems || [])].filter(i => i.value > 0);
        const shoppingData = purchaseItems.map(item => ({
          itemName: item.name,
          quantity: item.value,
          unit: item.unit || 'unit',
          formId: inserted.id,
          listDate: new Date(data.shiftDate),
        }));
        await tx.insert(shoppingList).values(shoppingData);
        await transporter.sendMail({
          from: process.env.GMAIL_USER,
          to: 'management@email.com',
          subject: `Daily Report ${data.shiftDate}`,
          text: `Sales: ฿${data.totalSales}\nExpenses: ฿${data.totalExpenses}`,
        });
      }
      return inserted;
    });
    res.json(result);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

app.get('/api/daily-stock-sales/drafts', async (req, res) => {
  const drafts = await db.select().from(dailyStockSales).where(eq(dailyStockSales.status, 'draft'));
  res.json(drafts);
});

app.get('/api/daily-stock-sales/:id', async (req, res) => {
  const form = await db.select().from(dailyStockSales).where(eq(dailyStockSales.id, req.params.id)).limit(1)[0];
  res.json(form);
});

app.get('/api/daily-stock-sales/search', async (req, res) => {
  const query = req.query.query;
  const results = await db.select().from(dailyStockSales).where(sql`completedBy ILIKE %${query}% OR shiftDate::text ILIKE %${query}%`).orderBy(desc(dailyStockSales.shiftDate));
  res.json(results);
});
Run & Verify

Install: npm i nodemailer jspdf.
Run migration.
Test: Submit draft (works), complete (saves, gen shopping, email), search forms, download PDF, load draft.
Check DB: SELECT * FROM daily_stock_sales WHERE status = 'completed';.
This fixes the form error (transaction wrap), adds view/search/download, retrieves drafts—data accurate, reliable for clients. Test—share error log if 500.