Goal (what we’re building)
A data-driven dashboard that shows the latest stored Shift Snapshot with:

Expenses (purchases in the shift window)

Variance (Opening + Purchases − Usage = Expected → Staff → Variance)

Shift Report Balance (staff banking vs POS payments)

Payments + Top Items
…and an Analysis section to browse snapshots.

Work order (do in this order)
Backend routes: add 3 read-only endpoints

GET /api/dashboard/latest

GET /api/analysis/list

GET /api/analysis/:id
(Optional: GET /api/snapshots/:id/items if missing)

Wire routes in server/routes.ts and restart server.

Frontend: replace Dashboard with the new, styled, data-driven version that reads /api/dashboard/latest.

Add Analysis menu (list + detail pages) using the new endpoints.

Accept: verify all three headline metrics render (Expenses, Variance, Balance) from stored data.

1) Backend — paste into server/routes.ts
This composes data from: ShiftSnapshot, PaymentBreakdown, SnapshotItem, JussiComparison, Expense, ExpenseLine, and DailySales.
It handles BigInt → number safely.

1.1 BigInt JSON helper (top of file, once)
ts
Copy
Edit
// Safe JSON for BigInt values
function safeJson(res: any, data: any, status = 200) {
  const json = JSON.stringify(
    data,
    (_k, v) => (typeof v === 'bigint' ? Number(v) : v)
  );
  res.status(status).setHeader('Content-Type', 'application/json').send(json);
}
1.2 Utilities (top or near the new routes)
ts
Copy
Edit
const THB = (satang?: number | bigint | null) => Number(satang ?? 0) / 100;

function toBKK(iso: Date) {
  return new Date(iso); // client formats to BKK; we just pass ISO
}

// Try to infer staff banking fields safely
function extractStaffBanking(ds: any) {
  // Adjust these if your column names differ
  return {
    closingCashTHB: Number(ds?.closingCashTHB ?? ds?.closingCash ?? 0),
    cashBankedTHB: Number(ds?.cashBankedTHB ?? ds?.cashBanked ?? 0),
    qrTransferTHB: Number(ds?.qrTransferTHB ?? ds?.qrTransfer ?? 0),
  };
}
1.3 Core builder to compose a dashboard snapshot
ts
Copy
Edit
async function buildSnapshotDTO(prisma: any, snapshotId: string) {
  const snapshot = await prisma.shiftSnapshot.findUnique({
    where: { id: snapshotId },
    include: {
      payments: true,
      items: { select: { itemName: true, qty: true, revenueSatang: true }, orderBy: { qty: 'desc' }, take: 50 },
      comparisons: { orderBy: { createdAt: 'desc' }, take: 1 },
    }
  });
  if (!snapshot) return null;

  const comp = snapshot.comparisons?.[0] ?? null;
  const start = snapshot.windowStartUTC;
  const end = snapshot.windowEndUTC;

  // Expenses (PURCHASE) in window
  const lines = await prisma.expenseLine.findMany({
    where: {
      Expense: { type: 'PURCHASE', expenseDate: { gte: start, lte: end } }
    },
    select: { qty: true, unitPriceTHB: true, lineTotalTHB: true, name: true }
  });
  let expensesTotal = 0;
  for (const l of lines) {
    const v = (l.lineTotalTHB != null)
      ? Number(l.lineTotalTHB)
      : (Number(l.qty ?? 0) * Number(l.unitPriceTHB ?? 0));
    expensesTotal += (isFinite(v) ? v : 0);
  }

  // Staff form within window (for banking)
  const ds = await prisma.dailySales.findFirst({
    where: { createdAt: { gte: start, lte: end } },
    orderBy: { createdAt: 'desc' }
  });
  const staffBank = extractStaffBanking(ds);

  // POS payments from snapshot
  const byChannel = Object.fromEntries((snapshot.payments || []).map((p: any) => [p.channel, p]));
  const posCashTHB = THB(byChannel['CASH']?.totalSatang);
  const posQrTHB   = THB(byChannel['QR']?.totalSatang);
  const posGrabTHB = THB(byChannel['GRAB']?.totalSatang);

  const balance = {
    staff: staffBank,
    pos: { cashTHB: posCashTHB, qrTHB: posQrTHB, grabTHB: posGrabTHB },
    diffs: {
      cashTHB: Number((staffBank.cashBankedTHB - posCashTHB).toFixed(2)),
      qrTHB:   Number((staffBank.qrTransferTHB - posQrTHB).toFixed(2)),
    }
  };

  // Format comparison response (purchases-aware)
  const comparison = comp ? {
    opening: {
      buns: comp.openingBuns ?? null,
      meatGram: comp.openingMeatGram ?? null,
      drinks: comp.openingDrinks ?? null,
    },
    purchases: {
      buns: comp.purchasedBuns ?? 0,
      meatGram: comp.purchasedMeatGram ?? 0,
      drinks: comp.purchasedDrinks ?? 0,
    },
    usagePOS: {
      buns: comp.expectedBuns ?? 0,
      meatGram: comp.expectedMeatGram ?? 0,
      drinks: comp.expectedDrinks ?? 0,
    },
    expectedClose: {
      buns: comp.expectedCloseBuns ?? 0,
      meatGram: comp.expectedCloseMeatGram ?? 0,
      drinks: comp.expectedCloseDrinks ?? 0,
    },
    staffClose: {
      buns: comp.staffBuns ?? null,
      meatGram: comp.staffMeatGram ?? null,
      drinks: comp.staffDrinks ?? null,
    },
    variance: {
      buns: comp.varBuns ?? null,
      meatGram: comp.varMeatGram ?? null,
      drinks: comp.varDrinks ?? null,
    },
    state: comp.state
  } : null;

  return {
    snapshot: {
      id: snapshot.id,
      windowStartUTC: toBKK(snapshot.windowStartUTC),
      windowEndUTC: toBKK(snapshot.windowEndUTC),
      totalReceipts: snapshot.totalReceipts,
      totalSalesTHB: Number((THB(snapshot.totalSalesSatang)).toFixed(2)),
      reconcileState: snapshot.reconcileState,
      reconcileNotes: snapshot.reconcileNotes ?? null,
      payments: (snapshot.payments || []).map((p: any) => ({
        channel: p.channel,
        count: p.count,
        totalTHB: Number((THB(p.totalSatang)).toFixed(2))
      })),
    },
    expenses: {
      totalTHB: Number(expensesTotal.toFixed(2)),
      linesCount: lines.length
    },
    comparison,
    balance,
    topItems: (snapshot.items || []).map((it: any) => ({
      itemName: it.itemName,
      qty: it.qty,
      revenueTHB: Number((THB(it.revenueSatang)).toFixed(2))
    }))
  };
}
1.4 Endpoints (paste into server/routes.ts)
ts
Copy
Edit
// GET latest dashboard snapshot
app.get('/api/dashboard/latest', async (req, res) => {
  const prisma = req.prisma || req.app.get('prisma');
  try {
    const latest = await prisma.shiftSnapshot.findFirst({
      orderBy: { windowStartUTC: 'desc' },
      select: { id: true }
    });
    if (!latest) return safeJson(res, { snapshot: null });
    const dto = await buildSnapshotDTO(prisma, latest.id);
    return safeJson(res, dto);
  } catch (e: any) {
    console.error(e);
    return res.status(500).json({ error: e.message });
  }
});

// GET analysis list (last 14)
app.get('/api/analysis/list', async (req, res) => {
  const prisma = req.prisma || req.app.get('prisma');
  try {
    const rows = await prisma.shiftSnapshot.findMany({
      orderBy: { windowStartUTC: 'desc' },
      take: 14,
      select: {
        id: true, windowStartUTC: true, windowEndUTC: true,
        totalReceipts: true, totalSalesSatang: true, reconcileState: true
      }
    });
    const mapped = rows.map((r: any) => ({
      id: r.id,
      windowStartUTC: r.windowStartUTC,
      windowEndUTC: r.windowEndUTC,
      totalReceipts: r.totalReceipts,
      totalSalesTHB: Number((THB(r.totalSalesSatang)).toFixed(2)),
      reconcileState: r.reconcileState
    }));
    return safeJson(res, mapped);
  } catch (e: any) {
    return res.status(500).json({ error: e.message });
  }
});

// GET analysis detail by snapshot id
app.get('/api/analysis/:id', async (req, res) => {
  const prisma = req.prisma || req.app.get('prisma');
  const { id } = req.params;
  try {
    const dto = await buildSnapshotDTO(prisma, id);
    if (!dto) return res.status(404).json({ error: 'Snapshot not found' });
    return safeJson(res, dto);
  } catch (e: any) {
    return res.status(500).json({ error: e.message });
  }
});

// OPTIONAL: Top items if not present yet
app.get('/api/snapshots/:id/items', async (req, res) => {
  const prisma = req.prisma || req.app.get('prisma');
  try {
    const rows = await prisma.snapshotItem.findMany({
      where: { snapshotId: req.params.id },
      orderBy: { qty: 'desc' },
      take: 50,
      select: { itemName: true, qty: true, revenueSatang: true }
    });
    return safeJson(res, rows.map((r:any)=>({
      itemName: r.itemName, qty: r.qty, revenueTHB: Number((THB(r.revenueSatang)).toFixed(2))
    })));
  } catch (e:any) {
    return res.status(500).json({ error: e.message });
  }
});
2) Frontend — replace the Dashboard with real data
Paste this over client/src/pages/Dashboard.tsx. It calls /api/dashboard/latest only. It includes Expenses, Variance, Shift Balance, Payments, and Top Items with clean styling.

tsx
Copy
Edit
import React, { useEffect, useMemo, useState } from 'react';

type DashboardDTO = {
  snapshot: {
    id: string;
    windowStartUTC: string;
    windowEndUTC: string;
    totalReceipts: number;
    totalSalesTHB: number;
    reconcileState: 'OK'|'MISMATCH'|'MISSING_DATA';
    reconcileNotes?: string | null;
    payments: { channel: 'CASH'|'QR'|'GRAB'|'CARD'|'OTHER'; count: number; totalTHB: number }[];
  } | null;
  expenses?: { totalTHB: number; linesCount: number };
  comparison?: {
    opening: { buns: number|null; meatGram: number|null; drinks: number|null };
    purchases: { buns: number; meatGram: number; drinks: number };
    usagePOS: { buns: number; meatGram: number; drinks: number };
    expectedClose: { buns: number; meatGram: number; drinks: number };
    staffClose: { buns: number|null; meatGram: number|null; drinks: number|null };
    variance: { buns: number|null; meatGram: number|null; drinks: number|null };
    state: 'OK'|'MISMATCH'|'MISSING_DATA';
  } | null;
  balance?: {
    staff: { closingCashTHB: number; cashBankedTHB: number; qrTransferTHB: number };
    pos: { cashTHB: number; qrTHB: number; grabTHB: number };
    diffs: { cashTHB: number; qrTHB: number };
  };
  topItems?: { itemName: string; qty: number; revenueTHB: number }[];
};

const currency = (n: number) =>
  new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', maximumFractionDigits: 2 }).format(n);

const Card: React.FC<{title: string; right?: React.ReactNode; children: React.ReactNode}> = ({ title, right, children }) => (
  <div className="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
    <div className="mb-3 flex items-center justify-between">
      <h3 className="text-sm font-semibold text-gray-700">{title}</h3>
      {right}
    </div>
    {children}
  </div>
);

const Badge: React.FC<{state: 'OK'|'MISMATCH'|'MISSING_DATA'}> = ({ state }) => {
  const cls = state === 'OK' ? 'bg-emerald-100 text-emerald-700'
    : state === 'MISSING_DATA' ? 'bg-amber-100 text-amber-700'
    : 'bg-rose-100 text-rose-700';
  return <span className={`px-2 py-1 rounded text-xs font-semibold ${cls}`}>{state}</span>;
};

function varianceClass(v: number | null, tol: number) {
  if (v == null) return 'text-gray-400';
  const a = Math.abs(v);
  if (a <= tol) return 'text-emerald-600';
  if (a <= tol * 2) return 'text-amber-600';
  return 'text-rose-600 font-semibold';
}
const withSign = (v: number | null) => (v == null ? '—' : (v > 0 ? '+' : '') + v.toLocaleString('en-US'));
const int = (n?: number | null) => (n ?? 0).toLocaleString('en-US');

export default function Dashboard() {
  const [data, setData] = useState<DashboardDTO | null>(null);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState<string | null>(null);

  useEffect(() => {
    (async () => {
      try {
        setErr(null);
        setLoading(true);
        const res = await fetch('/api/dashboard/latest', { headers: { Accept: 'application/json' }});
        if (!res.ok) throw new Error('Failed to load dashboard');
        const dto: DashboardDTO = await res.json();
        setData(dto);
      } catch (e:any) {
        setErr(e.message || 'Error');
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  const windowStr = useMemo(() => {
    if (!data?.snapshot) return '';
    const start = new Date(data.snapshot.windowStartUTC);
    const end = new Date(data.snapshot.windowEndUTC);
    const opts: Intl.DateTimeFormatOptions = { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Asia/Bangkok' };
    const day: Intl.DateTimeFormatOptions = { year: 'numeric', month: 'short', day: '2-digit', timeZone: 'Asia/Bangkok' };
    return `${start.toLocaleDateString('en-GB', day)} • ${start.toLocaleTimeString('en-GB', opts)} → ${end.toLocaleTimeString('en-GB', opts)} (BKK)`;
  }, [data]);

  if (loading) return <div className="p-6"><div className="h-8 w-64 rounded bg-gray-200 animate-pulse" /></div>;
  if (err) return <div className="p-6"><div className="rounded border bg-rose-50 p-4 text-rose-700">{err}</div></div>;
  if (!data?.snapshot) return <div className="p-6"><div className="rounded border bg-amber-50 p-4 text-amber-700">No snapshots yet.</div></div>;

  const snap = data.snapshot;

  return (
    <div className="p-6 space-y-6">
      <div className="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
        <h1 className="text-2xl font-semibold">Restaurant Operations Hub</h1>
        <div className="text-sm text-gray-500">{windowStr}</div>
      </div>

      {/* Top row */}
      <div className="grid gap-4 md:grid-cols-3">
        <Card title="Last Shift Snapshot" right={<Badge state={snap.reconcileState} />}>
          <div className="space-y-3">
            <div className="flex items-baseline justify-between">
              <div className="text-gray-500 text-sm">Gross sales</div>
              <div className="text-lg tabular-nums">{currency(snap.totalSalesTHB)}</div>
            </div>
            <div className="flex items-baseline justify-between">
              <div className="text-gray-500 text-sm">Receipts</div>
              <div className="text-lg">{int(snap.totalReceipts)}</div>
            </div>
            {snap.reconcileNotes ? (
              <div className="rounded border border-amber-200 bg-amber-50 p-2 text-xs text-amber-800">{snap.reconcileNotes}</div>
            ) : null}
          </div>
        </Card>

        <Card title="Payments">
          <div className="grid grid-cols-2 gap-2">
            {['CASH','QR','GRAB','CARD','OTHER'].map((k) => {
              const p = snap.payments.find(x => x.channel === k);
              return (
                <div key={k} className="rounded-lg border p-3">
                  <div className="text-xs text-gray-500">{k}</div>
                  <div className="text-base font-semibold tabular-nums">{p ? currency(p.totalTHB) : '—'}</div>
                  <div className="text-xs text-gray-400">{p ? `${int(p.count)} tx` : '—'}</div>
                </div>
              );
            })}
          </div>
        </Card>

        <Card title="Alerts">
          {snap.reconcileState === 'OK' ? (
            <div className="text-sm text-emerald-700">✅ All good. No variances beyond thresholds.</div>
          ) : snap.reconcileState === 'MISSING_DATA' ? (
            <div className="text-sm text-amber-700">⚠️ Missing staff counts and/or purchases. Add them, then Recompute.</div>
          ) : (
            <div className="text-sm text-rose-700">❗ Variances detected. Review Sales vs Staff and confirm purchases.</div>
          )}
          <div className="mt-3 flex gap-3">
            <a className="text-xs underline text-gray-600" href="/form-library">Open Form Library</a>
            <a className="text-xs underline text-gray-600" href="/finance/expenses">Purchasing</a>
            <a className="text-xs underline text-gray-600" href="/analysis">Open Analysis</a>
          </div>
        </Card>
      </div>

      {/* Middle row */}
      <div className="grid gap-4 md:grid-cols-3">
        <Card title="Sales vs Staff (Purchases-aware)">
          {data.comparison ? (
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="text-left text-gray-500">
                    <th className="py-2">Metric</th>
                    <th className="py-2">Buns</th>
                    <th className="py-2">Meat (g)</th>
                    <th className="py-2">Drinks</th>
                  </tr>
                </thead>
                <tbody className="tabular-nums">
                  <tr className="border-t"><td className="py-2 text-gray-500">Opening (prev shift)</td><td>{int(data.comparison.opening.buns)}</td><td>{int(data.comparison.opening.meatGram)}</td><td>{int(data.comparison.opening.drinks)}</td></tr>
                  <tr className="border-t"><td className="py-2 text-gray-500">+ Purchases</td><td>{int(data.comparison.purchases.buns)}</td><td>{int(data.comparison.purchases.meatGram)}</td><td>{int(data.comparison.purchases.drinks)}</td></tr>
                  <tr className="border-t"><td className="py-2 text-gray-500">− Usage (POS)</td><td>{int(data.comparison.usagePOS.buns)}</td><td>{int(data.comparison.usagePOS.meatGram)}</td><td>{int(data.comparison.usagePOS.drinks)}</td></tr>
                  <tr className="border-t"><td className="py-2 text-gray-500">= Expected Close</td><td className="font-medium">{int(data.comparison.expectedClose.buns)}</td><td className="font-medium">{int(data.comparison.expectedClose.meatGram)}</td><td className="font-medium">{int(data.comparison.expectedClose.drinks)}</td></tr>
                  <tr className="border-t"><td className="py-2 text-gray-500">Staff Closing</td><td>{int(data.comparison.staffClose.buns)}</td><td>{int(data.comparison.staffClose.meatGram)}</td><td>{int(data.comparison.staffClose.drinks)}</td></tr>
                  <tr className="border-t"><td className="py-2 text-gray-500">Variance</td>
                    <td className={varianceClass(data.comparison.variance.buns, 5)}>{withSign(data.comparison.variance.buns)}</td>
                    <td className={varianceClass(data.comparison.variance.meatGram, 500)}>{withSign(data.comparison.variance.meatGram)}</td>
                    <td className={varianceClass(data.comparison.variance.drinks, 3)}>{withSign(data.comparison.variance.drinks)}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          ) : <div className="text-sm text-gray-500">No comparison yet.</div>}
        </Card>

        <Card title="Shift Report Balance">
          <div className="grid grid-cols-2 gap-3 text-sm tabular-nums">
            <div>
              <div className="text-gray-500 mb-1">Staff</div>
              <div className="flex justify-between py-1"><span>Closing Cash</span><span>{currency(data.balance?.staff.closingCashTHB ?? 0)}</span></div>
              <div className="flex justify-between py-1"><span>Cash Banked</span><span>{currency(data.balance?.staff.cashBankedTHB ?? 0)}</span></div>
              <div className="flex justify-between py-1"><span>QR Transfer</span><span>{currency(data.balance?.staff.qrTransferTHB ?? 0)}</span></div>
            </div>
            <div>
              <div className="text-gray-500 mb-1">POS</div>
              <div className="flex justify-between py-1"><span>CASH</span><span>{currency(data.balance?.pos.cashTHB ?? 0)}</span></div>
              <div className="flex justify-between py-1"><span>QR</span><span>{currency(data.balance?.pos.qrTHB ?? 0)}</span></div>
              <div className="flex justify-between py-1"><span>GRAB</span><span>{currency(data.balance?.pos.grabTHB ?? 0)}</span></div>
            </div>
          </div>
          <div className="mt-3 rounded border p-2">
            <div className="flex justify-between text-sm"><span>Diff (Cash Banked − POS CASH)</span>
              <span className={`${(data.balance?.diffs.cashTHB ?? 0) === 0 ? 'text-emerald-600' : 'text-rose-600 font-semibold'}`}>
                {currency(Math.abs(data.balance?.diffs.cashTHB ?? 0))}{(data.balance?.diffs.cashTHB ?? 0)===0 ? '' : (data.balance!.diffs.cashTHB>0?' (+)':' (−)')}
              </span>
            </div>
            <div className="flex justify-between text-sm"><span>Diff (QR Transfer − POS QR)</span>
              <span className={`${(data.balance?.diffs.qrTHB ?? 0) === 0 ? 'text-emerald-600' : 'text-rose-600 font-semibold'}`}>
                {currency(Math.abs(data.balance?.diffs.qrTHB ?? 0))}{(data.balance?.diffs.qrTHB ?? 0)===0 ? '' : (data.balance!.diffs.qrTHB>0?' (+)':' (−)')}
              </span>
            </div>
          </div>
        </Card>

        <Card title="Expenses (Purchases in window)">
          <div className="flex items-baseline justify-between">
            <div className="text-gray-500 text-sm">Total</div>
            <div className="text-lg font-semibold tabular-nums">{currency(data.expenses?.totalTHB ?? 0)}</div>
          </div>
          <div className="mt-1 text-xs text-gray-500">{int(data.expenses?.linesCount)} lines</div>
          <div className="mt-3"><a className="text-xs underline text-gray-600" href="/finance/expenses">Open Purchasing</a></div>
        </Card>
      </div>

      {/* Bottom row */}
      {data.topItems && data.topItems.length ? (
        <Card title="Top Items (qty · revenue)">
          <div className="grid gap-2 md:grid-cols-2">
            {data.topItems.slice(0, 12).map((it) => (
              <div key={it.itemName} className="flex items-center justify-between rounded border p-3">
                <div className="text-sm text-gray-700 truncate">{it.itemName}</div>
                <div className="text-sm tabular-nums">
                  <span className="mr-3 text-gray-500">{int(it.qty)}x</span>
                  <span className="font-medium">{currency(it.revenueTHB)}</span>
                </div>
              </div>
            ))}
          </div>
        </Card>
      ) : null}
    </div>
  );
}
3) Analysis menu (minimal)
Add a sidebar entry “Analysis” → routes:

/analysis → list

/analysis/:id → detail (reuse dashboard cards with /api/analysis/:id)

client/src/pages/AnalysisList.tsx
tsx
Copy
Edit
import React, { useEffect, useState } from 'react';

export default function AnalysisList() {
  const [rows, setRows] = useState<any[]>([]);
  const [err, setErr] = useState<string|null>(null);

  useEffect(()=>{(async()=>{
    try {
      const r = await fetch('/api/analysis/list', { headers: { Accept: 'application/json' } });
      if (!r.ok) throw new Error('Failed to load');
      setRows(await r.json());
    } catch(e:any){ setErr(e.message); }
  })()},[]);

  if (err) return <div className="p-6 text-rose-700">{err}</div>;
  return (
    <div className="p-6 space-y-4">
      <h1 className="text-2xl font-semibold">Analysis</h1>
      <div className="rounded-xl border bg-white">
        <table className="w-full text-sm">
          <thead><tr className="text-left text-gray-500">
            <th className="py-2 px-3">Window (BKK)</th><th className="py-2 px-3">Sales</th><th className="py-2 px-3">Receipts</th><th className="py-2 px-3">State</th><th></th>
          </tr></thead>
          <tbody>
            {rows.map(r=>(
              <tr key={r.id} className="border-t">
                <td className="py-2 px-3">{new Date(r.windowStartUTC).toLocaleString('en-GB',{timeZone:'Asia/Bangkok'})} → {new Date(r.windowEndUTC).toLocaleTimeString('en-GB',{timeZone:'Asia/Bangkok'})}</td>
                <td className="py-2 px-3">฿{r.totalSalesTHB.toLocaleString()}</td>
                <td className="py-2 px-3">{r.totalReceipts}</td>
                <td className="py-2 px-3">{r.reconcileState}</td>
                <td className="py-2 px-3"><a className="text-xs underline" href={`/analysis/${r.id}`}>Open</a></td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
client/src/pages/AnalysisDetail.tsx
Re-use the Dashboard page layout but fetch from /api/analysis/:id instead of /api/dashboard/latest. (Agent can copy Dashboard.tsx and swap the fetch URL using useParams().)

4) Acceptance checklist (what “done” looks like)
Dashboard shows latest stored snapshot (not live).

Expenses card total matches purchase lines inside the window.

Variance table shows Opening / Purchases / Usage / Expected / Staff / Variance with color thresholds.

Shift Report Balance shows staff vs POS and clear diffs.

Payments and Top Items render from snapshot.

Analysis menu is visible, list of last 14 snapshots works, detail page mirrors dashboard layout for that snapshot.

5) Runbook
bash
Copy
Edit
# 1) Backend changes
# paste routes into server/routes.ts, save, restart server

# 2) Frontend
# replace client/src/pages/Dashboard.tsx with the new file
# add client/src/pages/AnalysisList.tsx (and AnalysisDetail.tsx)
# add router entries + sidebar link "Analysis"

# 3) Verify
curl -s http://localhost:5000/api/dashboard/latest | head
curl -s http://localhost:5000/api/analysis/list | head