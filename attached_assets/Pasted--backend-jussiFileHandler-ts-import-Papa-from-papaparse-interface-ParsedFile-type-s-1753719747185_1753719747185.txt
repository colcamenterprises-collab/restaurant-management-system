// /backend/jussiFileHandler.ts
import Papa from 'papaparse';

interface ParsedFile {
  type: 'shift' | 'sales';
  date: string;
  content: any[];
}

const fileStore: {
  shiftData?: ParsedFile;
  salesData?: ParsedFile;
} = {};

export function handleUpload(file: File): Promise<string> {
  return new Promise((resolve, reject) => {
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: (result) => {
        const fileName = file.name.toLowerCase();
        const content = result.data;
        const date = extractDate(fileName, content);

        if (!date) return reject('❌ Unable to detect shift date.');

        if (fileName.includes('shift') || fileName.includes('register') || fileName.includes('pos')) {
          fileStore.shiftData = { type: 'shift', date, content };
          resolve('✅ Shift Report uploaded');
        } else if (fileName.includes('sales') || fileName.includes('stock') || fileName.includes('form')) {
          fileStore.salesData = { type: 'sales', date, content };
          resolve('✅ Daily Sales Form uploaded');
        } else {
          reject('❌ Unrecognized file. Please include "shift" or "sales" in the filename.');
        }

        // Run comparison if both are ready and match
        if (
          fileStore.shiftData?.date === fileStore.salesData?.date
        ) {
          compareFiles(fileStore.shiftData, fileStore.salesData);
        }
      },
      error: (err) => reject(err.message),
    });
  });
}

function extractDate(fileName: string, content: any[]): string | null {
  const match = fileName.match(/\d{4}-\d{2}-\d{2}/);
  if (match) return match[0];
  if (content[0]?.Date) return content[0].Date;
  return null;
}

function compareFiles(shift: ParsedFile, sales: ParsedFile): void {
  const THRESHOLD = 50;
  const errors: string[] = [];

  const grabShift = parseFloat(shift.content[0]?.Grab || '0');
  const grabSales = parseFloat(sales.content[0]?.Grab || '0');

  const variance = Math.abs(grabShift - grabSales);

  if (variance > THRESHOLD) {
    errors.push(`⚠️ GRAB Sales mismatch: POS = ${grabShift}, Manual = ${grabSales}`);
  }

  const result = {
    date: shift.date,
    status: errors.length > 0 ? 'Discrepancy Detected' : 'Matched',
    issues: errors,
  };

  // Optionally store to daily_report_library or trigger Jussi's frontend view
  console.log('Jussi Report:', result);
}
