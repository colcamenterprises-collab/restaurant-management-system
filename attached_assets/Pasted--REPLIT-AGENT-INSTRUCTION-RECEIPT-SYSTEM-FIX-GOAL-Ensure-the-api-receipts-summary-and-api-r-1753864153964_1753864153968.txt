âœ… REPLIT AGENT INSTRUCTION â€“ RECEIPT SYSTEM FIX
ðŸŽ¯ GOAL:
Ensure the /api/receipts/summary and /api/receipts/summary-with-ids endpoints only use live receipt data from Loyverse API, using real receipt numbers like 6-36175, not fabricated ones like 1001.

ðŸ§  CONTEXT:
Current summaries are showing incorrect/stale/test data

Actual receipts from Loyverse use receipt_number format like 6-36175

The number of receipts and totals are incorrect compared to the real exported data

This breaks trust in Jussiâ€™s reporting

ðŸ”§ REQUIRED FIXES:
1. Bypass Local Receipt Caching
ts
Copy
Edit
// backend/routes/receipts.ts
// REMOVE or DISABLE any reference to cached test JSON or fallback JSON data
// DELETE code like this:
const testData = require("../test-data/receipts.json");
2. Update /api/receipts/summary to Use Live API
ts
Copy
Edit
import express from "express";
import db from "../db";
import { getReceiptsFromLoyverseAPI } from "../services/loyverse";
import { getBangkokShiftTimeRange } from "../utils/time";

const router = express.Router();

router.get("/summary", async (req, res) => {
  try {
    const { startTime, endTime } = getBangkokShiftTimeRange(); // 5PMâ€“3AM BKK
    const receipts = await getReceiptsFromLoyverseAPI(startTime, endTime);

    const totalGross = receipts.reduce((acc, r) => acc + r.total_amount, 0);
    const totalNet = receipts.reduce((acc, r) => acc + (r.total_amount - (r.total_discount || 0)), 0);
    const firstReceipt = receipts[0]?.receipt_number || "N/A";
    const lastReceipt = receipts[receipts.length - 1]?.receipt_number || "N/A";

    const paymentTypes = {};
    receipts.forEach(r => {
      const method = r.payment_method || "Unknown";
      paymentTypes[method] = (paymentTypes[method] || 0) + 1;
    });

    res.json({
      totalReceipts: receipts.length,
      totalGross,
      totalNet,
      firstReceipt,
      lastReceipt,
      paymentTypes,
      receipts,
    });
  } catch (error) {
    console.error("Error fetching receipt summary:", error);
    res.status(500).json({ error: "Failed to fetch live receipt summary" });
  }
});
3. Fix getReceiptsFromLoyverseAPI() to Pull Live Data
Ensure this function uses real credentials and pagination to pull full receipt data:

ts
Copy
Edit
// services/loyverse.ts
import axios from "axios";

export async function getReceiptsFromLoyverseAPI(startTime: string, endTime: string) {
  const headers = {
    Authorization: `Bearer ${process.env.LOYVERSE_API_KEY}`,
  };

  const results = [];
  let cursor = null;

  do {
    const url = `https://api.loyverse.com/v1.0/receipts?created_at_min=${startTime}&created_at_max=${endTime}&limit=250${cursor ? `&cursor=${cursor}` : ""}`;
    const response = await axios.get(url, { headers });
    results.push(...response.data.receipts);
    cursor = response.data.cursor;
  } while (cursor);

  return results;
}
4. Correct the CSV Export
Update /api/receipts/download to export real receipt_number values (e.g., 6-36175) and ensure all fields match Loyverse exports:

ts
Copy
Edit
import { Parser } from "json2csv";

router.get("/download", async (req, res) => {
  const { startTime, endTime } = getBangkokShiftTimeRange();
  const receipts = await getReceiptsFromLoyverseAPI(startTime, endTime);

  const fields = [
    "receipt_number",
    "created_at",
    "total_amount",
    "payment_method",
    "customer_name",
    "items_count",
    "refunded",
    "store_name"
  ];

  const parser = new Parser({ fields });
  const csv = parser.parse(receipts);

  res.header("Content-Type", "text/csv");
  res.attachment(`receipts_${startTime.slice(0,10)}.csv`);
  res.send(csv);
});
5. Frontend: Fix Receipt Summary UI (React)
Ensure summary shows:

âœ… Actual receipt numbers

âœ… Real-time counts

âœ… Accurate payment methods

âœ… Pulls from the updated backend

Update fetch to call:

js
Copy
Edit
const res = await fetch("/api/receipts/summary");
const data = await res.json();
And bind:

jsx
Copy
Edit
<p>Receipts: {data.totalReceipts}</p>
<p>First Receipt: {data.firstReceipt}</p>
<p>Last Receipt: {data.lastReceipt}</p>
<p>Gross Sales: à¸¿{data.totalGross}</p>
<p>Net Sales: à¸¿{data.totalNet}</p>
âœ… FINAL OUTCOME:
Only real Loyverse receipt numbers (e.g., 6-36175)

Live, accurate receipt summaries from 5PMâ€“3AM BKK time

Fully working download CSV with all required fields

Jussi and dashboard now reflect truth in reporting

