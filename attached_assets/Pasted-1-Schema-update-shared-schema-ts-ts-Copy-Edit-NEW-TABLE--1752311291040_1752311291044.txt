1 â€“ Schema update (shared/schema.ts)
ts
Copy
Edit
// â”€â”€â”€ NEW TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export const dailyShiftReceiptSummary = pgTable("daily_shift_receipt_summary", {
  id: serial("id").primaryKey(),
  /* shift date is the date that 6 PM belongs to (e.g. 2025-07-12) */
  shiftDate: date("shift_date").notNull().unique(),
  burgersSold: integer("burgers_sold").notNull().default(0),
  drinksSold: integer("drinks_sold").notNull().default(0),
  /* full JSON blobs so we can drill-down later */
  itemsBreakdown: jsonb("items_breakdown")
    .$type<Record<string, { qty: number; sales: number }>>()
    .notNull(),
  modifiersSummary: jsonb("modifiers_summary")
    .$type<Record<string, { qty: number; sales: number }>>()
    .notNull(),
  createdAt: timestamp("created_at").defaultNow(),
});

// â”€â”€â”€ INSERT SCHEMA & TYPES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export const insertDailyReceiptSummarySchema =
  createInsertSchema(dailyShiftReceiptSummary).omit({ id: true, createdAt: true });

export type DailyShiftReceiptSummary =
  typeof dailyShiftReceiptSummary.$inferSelect;
export type InsertDailyShiftReceiptSummary =
  z.infer<typeof insertDailyReceiptSummarySchema>;
Run npm run db:push (push-mode Drizzle).

2 â€“ Service server/services/receiptSummary.ts
ts
Copy
Edit
import { db } from "../db";
import {
  loyverseReceipts,
  dailyShiftReceiptSummary,
  insertDailyReceiptSummarySchema,
} from "@shared/schema";
import { between } from "drizzle-orm";

/** Helper: return [shiftStartUTC, shiftEndUTC] for any Bangkok-date (yyyy-mm-dd). */
export function getShiftWindow(dateStr: string): [Date, Date] {
  // 6 PM Bangkok
  const start = new Date(`${dateStr}T11:00:00Z`);       // 18:00 +07 == 11:00Z
  const end = new Date(`${dateStr}T20:00:00Z`);         // 03:00 +07 next day == 20:00Z
  end.setUTCDate(end.getUTCDate() + 1);
  return [start, end];
}

/** Categorisation rules */
const categoryOf = (name = "") => {
  const n = name.toLowerCase();
  if (n.includes("burger")) return "BURGERS";
  if (n.includes("fries") || n.includes("side")) return "SIDE ORDERS";
  if (n.includes("add") || n.includes("extra")) return "BURGER EXTRAS";
  if (n.includes("coke") || n.includes("water") || n.includes("drink"))
    return "DRINKS";
  return "OTHER";
};

/** Build + save summary for a given Bangkok date (yyyy-mm-dd). */
export async function buildShiftSummary(dateStr: string) {
  const [start, end] = getShiftWindow(dateStr);

  // grab all receipts in range
  const receipts = await db
    .select()
    .from(loyverseReceipts)
    .where(between(loyverseReceipts.receiptDate, start, end));

  const itemsMap: Record<string, { qty: number; sales: number }> = {};
  const modsMap: Record<string, { qty: number; sales: number }> = {};
  let burgersSold = 0;
  let drinksSold = 0;

  receipts.forEach((r) => {
    (r.items ?? []).forEach((it: any) => {
      const key = it.item_name ?? "unknown";
      const cat = categoryOf(key);
      const qty = it.quantity ?? 1;
      const sales = parseFloat(it.total_money ?? it.line_total ?? 0);

      itemsMap[cat] ??= { qty: 0, sales: 0 };
      itemsMap[cat].qty += qty;
      itemsMap[cat].sales += sales;

      if (cat === "BURGERS") burgersSold += qty;
      if (cat === "DRINKS") drinksSold += qty;

      // modifiers
      (it.line_modifiers ?? []).forEach((m: any) => {
        const mkey = m.name ?? "modifier";
        modsMap[mkey] ??= { qty: 0, sales: 0 };
        modsMap[mkey].qty += 1;
        modsMap[mkey].sales += parseFloat(m.money_amount ?? 0);
      });
    });
  });

  const data = insertDailyReceiptSummarySchema.parse({
    shiftDate: dateStr,
    burgersSold,
    drinksSold,
    itemsBreakdown: itemsMap,
    modifiersSummary: modsMap,
  });

  await db
    .insert(dailyShiftReceiptSummary)
    .values(data)
    .onConflictDoUpdate({ target: dailyShiftReceiptSummary.shiftDate, set: data });
  return data;
}
3 â€“ Scheduler server/services/scheduler.ts
Add a daily cron-like schedule:

ts
Copy
Edit
import cron from "node-cron";
import { buildShiftSummary } from "./receiptSummary";

export function startDailySummaryJob() {
  // 3:05 AM Bangkok daily  => 20:05Z
  cron.schedule("5 20 * * *", async () => {
    const bangkokNow = new Date(new Date().getTime() + 7 * 3600_000);
    const dateStr = bangkokNow.toISOString().slice(0, 10); // yyyy-mm-dd for the â€œpreviousâ€ shift
    console.log("ğŸ“Š Building shift summary for", dateStr);
    await buildShiftSummary(dateStr);
  });
}
Call startDailySummaryJob() from server/index.ts right after the server starts.

4 â€“ API route server/routes.ts
ts
Copy
Edit
// NEW: latest summary
app.get("/api/shift-summary/latest", async (_, res) => {
  const latest = await db
    .select()
    .from(dailyShiftReceiptSummary)
    .orderBy(desc(dailyShiftReceiptSummary.shiftDate))
    .limit(1);
  res.json(latest[0] ?? {});
});
5 â€“ Dashboard widget client/src/components/ShiftSummaryCard.tsx
tsx
Copy
Edit
import { useQuery } from "@tanstack/react-query";

export default function ShiftSummaryCard() {
  const { data, isLoading } = useQuery({
    queryKey: ["latest-shift-summary"],
    queryFn: () =>
      fetch("/api/shift-summary/latest").then((r) => r.json()),
    refetchInterval: 60_000,
  });

  if (isLoading) return <div className="card">Loadingâ€¦</div>;
  if (!data || !data.shiftDate) return null;

  const cats = data.itemsBreakdown as Record<
    string,
    { qty: number; sales: number }
  >;

  return (
    <div className="card">
      <h3 className="card-title">
        Shift Summary â€“ {data.shiftDate}
      </h3>
      <div className="grid grid-cols-2 gap-3 mt-2">
        {Object.entries(cats).map(([cat, v]) => (
          <div key={cat} className="p-2 bg-muted rounded">
            <div className="text-sm font-medium">{cat}</div>
            <div className="text-xl font-bold">{v.qty}</div>
          </div>
        ))}
      </div>
      <div className="mt-4 flex gap-4">
        <span>ğŸ” Burgers: {data.burgersSold}</span>
        <span>ğŸ¥¤ Drinks: {data.drinksSold}</span>
      </div>
    </div>
  );
}
Import the card in Dashboard.tsx:

tsx
Copy
Edit
import ShiftSummaryCard from "../components/ShiftSummaryCard";
/* â€¦ inside layout â€¦ */
<ShiftSummaryCard />
6 â€“ Tests / Verification
Unit â€“ run the service for yesterday manually:

bash
Copy
Edit
npx tsx server/services/receiptSummary.ts 2025-07-12
(Add a small script that calls buildShiftSummary(process.argv[2]).)

API â€“ curl http://localhost:5000/api/shift-summary/latest
â†’ JSON with burgersSold / drinksSold etc.

Dashboard â€“ open the page; card shows todayâ€™s summary.

Cron â€“ set system clock forward or change cron to * * * * * for quick test; confirm row appended / updated.

