Master system prompt (paste as the first message to any AI working on this repo)

Context

Full architecture + schemas are in DATABASE_APP_SNAPSHOT.md. Use it as source of truth.

Runtime: Node/Express + Postgres (Neon). ORM: Drizzle + some raw SQL.

Money is stored in integer cents.

Do NOT change DB schema or ORM. No migrations. No Prisma.

Daily Sales V2 API is already working (see snapshot routes). Frontend still shows NaN and hides buns/meat/shopping due to unsafe formatting & field-name drift.

Execution rules

Touch only the files I list. Make a .bak first for each edited file.

No schema/ORM changes, no migrations, no new packages.

Return exact patch content (copy-pasteable) and run the verification commands included.

If blocked by a missing file/path, stop and show the exact path you searched and what you need.

Prefer small, surgical diffs over refactors.

Goal (this task)

Fix Daily Sales Library + View so:

No NaN anywhere (safe THB formatter).

Cash fields, totals, Aroi/Grab etc. render correctly whether values are top-level or inside payload.

Show Burger Buns (Start/End) and Meat (Start/End) using:

buns: rollsStart/rollsEnd (fallback: burgerBunsStart/burgerBunsEnd)

meat: meatStartGrams/meatEndGrams (fallback: meatStart/meatEnd)

Show shopping list from payload.shoppingList (array of {sku, qty}).

Files you may edit (frontend only)

client/src/pages/operations/daily-sales/Library.tsx

client/src/pages/operations/daily-sales/View.tsx

Do not edit

Any backend file unless I explicitly ask.

Any schema/ORM file, migrations, or env.

After patch

Run npm run start, refresh the app.

Use the curl in â€œVerificationâ€ below to attach stock + shopping to a test record.

Confirm Library + View show correct data (no NaN, buns/meat, shopping list).

ðŸ”§ Exact patch (frontend only)

This is copy-pasteable. Itâ€™s safe, small, and schema-free.

1) client/src/pages/operations/daily-sales/Library.tsx

Backup

cp client/src/pages/operations/daily-sales/Library.tsx client/src/pages/operations/daily-sales/Library.tsx.bak


Edit Library.tsx and add these helpers under the imports (replace any existing THB formatter with this block):

// ---------- SAFE HELPERS ----------
const toBahtNumber = (v: unknown): number => {
  if (v === null || v === undefined) return 0;
  if (typeof v === "number" && Number.isFinite(v)) return v / 100;
  if (typeof v === "string" && v.trim() !== "" && !isNaN(Number(v))) return Number(v) / 100;
  return 0;
};

const THB = (v: unknown): string =>
  "à¸¿" + toBahtNumber(v).toLocaleString("en-TH", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

const fromRow = (row: any, key: string, fallback: any = 0) =>
  row?.[key] ?? row?.payload?.[key] ?? fallback;

const getBunsStart = (row: any) => fromRow(row, "rollsStart", fromRow(row, "burgerBunsStart", null));
const getBunsEnd   = (row: any) => fromRow(row, "rollsEnd",   fromRow(row, "burgerBunsEnd",   null));
const getMeatStart = (row: any) => fromRow(row, "meatStartGrams", fromRow(row, "meatStart", null));
const getMeatEnd   = (row: any) => fromRow(row, "meatEndGrams",   fromRow(row, "meatEnd",   null));

const getStaff = (row: any) =>
  row?.completedBy ?? row?.staff ?? row?.payload?.staffName ?? "";
// ----------------------------------


In your table cell renders, replace the expressions for these fields:

// Staff
{getStaff(row)}

// Cash Start
{THB(fromRow(row, "startingCash"))}

// Cash End
{THB(fromRow(row, "endingCash"))}

// Total Sales
{THB(fromRow(row, "totalSales"))}


If you show others (Aroi/Grab/Banked/QR), render with the same pattern:

{THB(fromRow(row, "aroiSales"))}
{THB(fromRow(row, "grabSales"))}
{THB(fromRow(row, "cashBanked"))}
{THB(fromRow(row, "qrTransfer"))}


Add (or fix) buns & meat columns in the row render:

{/* Burger Buns (Start/End) */}
{(() => {
  const s = getBunsStart(row);
  const e = getBunsEnd(row);
  return (s ?? "/") + " / " + (e ?? "/");
})()}

{/* Meat (Start/End) */}
{(() => {
  const s = getMeatStart(row);
  const e = getMeatEnd(row);
  return (s ?? "/") + " / " + (e ?? "/") + " g";
})()}

2) client/src/pages/operations/daily-sales/View.tsx

Backup

cp client/src/pages/operations/daily-sales/View.tsx client/src/pages/operations/daily-sales/View.tsx.bak


Edit View.tsx and paste the same helper block under the imports (exactly as above).

Replace value reads in the modal/details with safe accessors:

{/* Date */}
{row?.shiftDate}

{/* Completed By */}
{getStaff(row)}

{/* Cash Start / End */}
{THB(fromRow(row, "startingCash"))}
{THB(fromRow(row, "endingCash"))}

{/* Cash Banked / Grab Sales / Aroi Dee Sales */}
{THB(fromRow(row, "cashBanked"))}
{THB(fromRow(row, "grabSales"))}
{THB(fromRow(row, "aroiSales"))}

{/* Burger Buns (Start/End) */}
{(() => {
  const s = getBunsStart(row);
  const e = getBunsEnd(row);
  return (s ?? "/") + " / " + (e ?? "/");
})()}

{/* Meat Count (Start/End) */}
{(() => {
  const s = getMeatStart(row);
  const e = getMeatEnd(row);
  return (s ?? "/") + " / " + (e ?? "/") + " g";
})()}


Add Shopping List section at the bottom of the modal:

<div className="mt-4">
  <div className="font-semibold">Shopping List</div>
  {(() => {
    const list = fromRow(row, "shoppingList", fromRow(row, "shopping", [])) as Array<{ sku?: string; qty?: number }>;
    if (!Array.isArray(list) || list.length === 0) return <div className="text-sm text-gray-500">No items</div>;
    return (
      <ul className="list-disc pl-5 text-sm">
        {list.map((it, idx) => (
          <li key={idx}>
            {(it?.sku ?? "Item")} â€” {it?.qty ?? 0}
          </li>
        ))}
      </ul>
    );
  })()}
</div>

âœ… Verification

Restart

npm run start


Attach stock + shopping to a known record (replace <ID>):

curl -s -X PATCH http://localhost:5000/api/forms/daily-sales/v2/<ID>/stock \
  -H "Content-Type: application/json" \
  -d '{"rollsStart":10,"rollsEnd":18,"meatStartGrams":2800,"meatEndGrams":3200,"shoppingList":[{"sku":"Coke","qty":24},{"sku":"Sprite","qty":12}]}'


Refresh UI â†’ Library should show no NaN, buns/meat populated, and View modal should list shopping items.

Why this fixes it

No NaN: THB() guards all cases (undefined/null/string/numbers).

Field drift: fromRow() transparently pulls from either top-level or payload.

Buns/Meat/Shopping: explicitly mapped to the keys your backend/population uses without requiring DB changes.