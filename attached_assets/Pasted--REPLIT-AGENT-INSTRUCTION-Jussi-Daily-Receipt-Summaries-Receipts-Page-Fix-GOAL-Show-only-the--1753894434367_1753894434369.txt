 REPLIT AGENT INSTRUCTION: Jussi Daily Receipt Summaries + Receipts Page Fix
ğŸ”§ GOAL:
Show only the most recent shift (5 PM â€“ 3 AM) by default on the Receipts Page.

Let Jussi process and store receipt summaries for the last 31 days using live API data.

Enable shift search, daily automation, and download.

ğŸ“¦ FILE STRUCTURE CHANGES
Create /server/services/jussiDailySummaryService.ts

Modify /server/routes/receipts.ts

Update /client/pages/Receipts.tsx

Create or update /db/schema.ts to include daily_receipt_summaries table

1. âœ… BACKEND: Daily Summary Service (Jussi)
/server/services/jussiDailySummaryService.ts

ts
Copy
Edit
import { db } from "../db";
import { getReceiptsByDate } from "./liveReceiptService";
import { parseItemsSummary, parseDrinksSummary, parseRollsUsed } from "./receiptUtils"; // assume utils for these

export async function generateJussiSummaryForDate(date: string) {
  const receipts = await getReceiptsByDate(date); // returns receipts from 5 PM to 3 AM (shift logic inside)

  if (!receipts || receipts.length === 0) return null;

  const firstReceipt = receipts[0].receipt_number;
  const lastReceipt = receipts[receipts.length - 1].receipt_number;

  let gross = 0;
  let net = 0;
  const payments = {};
  const refunds = [];
  const items = [];
  const modifiers = [];

  for (const r of receipts) {
    gross += r.total_amount;
    net += r.total_amount - (r.refund_amount || 0);
    payments[r.payment_method] = (payments[r.payment_method] || 0) + 1;
    if (r.refunded) refunds.push(r);
    items.push(...r.items);
    modifiers.push(...(r.modifiers || []));
  }

  const itemSummary = parseItemsSummary(items);
  const drinkSummary = parseDrinksSummary(items);
  const rollsUsed = parseRollsUsed(itemSummary);

  await db.daily_receipt_summaries.upsert({
    where: { shift_date: date },
    update: {
      first_receipt: firstReceipt,
      last_receipt: lastReceipt,
      gross_sales: gross,
      net_sales: net,
      payments: payments,
      refunds_count: refunds.length,
      items_summary: itemSummary,
      drinks_summary: drinkSummary,
      rolls_used: rollsUsed,
    },
    create: {
      shift_date: date,
      first_receipt: firstReceipt,
      last_receipt: lastReceipt,
      gross_sales: gross,
      net_sales: net,
      payments: payments,
      refunds_count: refunds.length,
      items_summary: itemSummary,
      drinks_summary: drinkSummary,
      rolls_used: rollsUsed,
    },
  });
}
2. âœ… DATABASE: Add Daily Summary Table
/db/schema.ts

ts
Copy
Edit
daily_receipt_summaries: pgTable("daily_receipt_summaries", {
  id: serial("id").primaryKey(),
  shift_date: date("shift_date").unique().notNull(),
  first_receipt: varchar("first_receipt", { length: 32 }),
  last_receipt: varchar("last_receipt", { length: 32 }),
  gross_sales: numeric("gross_sales"),
  net_sales: numeric("net_sales"),
  payments: json("payments"),
  refunds_count: integer("refunds_count"),
  items_summary: json("items_summary"),
  drinks_summary: json("drinks_summary"),
  rolls_used: integer("rolls_used"),
  created_at: timestamp("created_at").defaultNow(),
})
3. âœ… ROUTE: Trigger Daily Summary Manually
/server/routes/receipts.ts

ts
Copy
Edit
router.post("/summary/generate/:date", async (req, res) => {
  const date = req.params.date;
  try {
    const summary = await generateJussiSummaryForDate(date);
    res.status(200).json({ success: true, summary });
  } catch (err) {
    res.status(500).json({ error: "Error generating summary" });
  }
});
4. âœ… CRON JOB: Generate Daily Summary @ 3:30 AM
/server/scheduledTasks.ts

ts
Copy
Edit
import cron from "node-cron";
import { generateJussiSummaryForDate } from "./services/jussiDailySummaryService";
import { getYesterdayDateBKK } from "./utils/dateHelpers";

cron.schedule("30 3 * * *", async () => {
  const date = getYesterdayDateBKK(); // BKK shift from 5PMâ€“3AM = â€œyesterdayâ€'s date
  await generateJussiSummaryForDate(date);
});
5. âœ… FRONTEND: Receipts Page Update
/client/pages/Receipts.tsx

Only load last completed shift's summary by default (/api/receipts/summary)

Add Date Picker/Search to fetch /api/receipts/summary/:date

Show:

First & Last Receipt

Total Receipts

Gross / Net Sales

Payments

Refunds

Items sold

Modifiers

Drinks sold

Rolls used

Add â€œğŸ” Re-Generate Summaryâ€ button â†’ calls /summary/generate/:date

Add CSV Download button (existing)

ğŸ§  NOTES FOR JUSSI INTEGRATION
Jussi should pull all calculations from daily_receipt_summaries table rather than parsing receipts on-demand. This ensures:

Faster load time

Shift summaries are consistent

Home and Analysis pages can reference this data too

âœ… ONCE COMPLETE
Update Home.tsx and Analysis.tsx to use daily_receipt_summaries:

Show:

Last Shift Summary (Home)

Rolls vs Actual vs Expected

Drink breakdown

Trends across days