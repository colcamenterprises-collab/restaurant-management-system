Replit Agent Instructions

Do not do this:

Do not rename, move, or split files.

Do not change database schema, tables, or JSON structure.

Do not remove or alter toCents / fromCents / thb() helpers.

Do not add any dependencies.

Do not improvise or “improve” code outside of exactly what is written.

Do not modify unrelated files.

Only replace the file contents below exactly as written.

1. client/src/pages/operations/daily-sales/Form.tsx
// Do not do this:
// – Do not rename, move, or split this file
// – Do not change schema, DB, or API contracts
// – Do not remove or alter thb() formatting
// – Do not add any extra dependencies
// – Only apply exactly what is written below

import React, { useState, useEffect } from "react";
import { thb } from "@/lib/utils";

export default function DailySalesForm() {
  const [completedBy, setCompletedBy] = useState("");
  const [startingCash, setStartingCash] = useState(0);
  const [cashSales, setCashSales] = useState(0);
  const [qrSales, setQrSales] = useState(0);
  const [grabSales, setGrabSales] = useState(0);
  const [aroiDeeSales, setAroiDeeSales] = useState(0);

  const [expenses, setExpenses] = useState<
    { item: string; cost: number; shop: string }[]
  >([{ item: "", cost: 0, shop: "" }]);

  const [wages, setWages] = useState<
    { staff: string; amount: number; type: string }[]
  >([{ staff: "", amount: 0, type: "Wages" }]);

  const [closingCash, setClosingCash] = useState(0);
  const [cashBanked, setCashBanked] = useState(0);
  const [qrTransfer, setQrTransfer] = useState(0);

  const [totalSales, setTotalSales] = useState(0);
  const [totalExpenses, setTotalExpenses] = useState(0);

  // ---- Auto-calcs ----
  useEffect(() => {
    const sales = cashSales + qrSales + grabSales + aroiDeeSales;
    setTotalSales(sales);

    const expenseSum =
      expenses.reduce((sum, e) => sum + (e.cost || 0), 0) +
      wages.reduce((sum, w) => sum + (w.amount || 0), 0);
    setTotalExpenses(expenseSum);

    // Final formula: Cash Banked = Cash Sales - Expenses
    const banked = cashSales - expenseSum;
    setCashBanked(banked < 0 ? 0 : banked);

    setQrTransfer(qrSales);
  }, [cashSales, qrSales, grabSales, aroiDeeSales, expenses, wages]);

  // ---- Styling based on style guide ----
  const pageTitle = "text-2xl font-extrabold font-[Poppins]";
  const sectionHeader = "text-lg font-semibold font-[Poppins] mb-2";
  const label = "block text-sm font-medium font-[Poppins] mb-1";
  const input =
    "w-full rounded-md border border-gray-300 p-2 text-base font-[Poppins] focus:outline-none focus:ring-2 focus:ring-black";
  const readonlyInput =
    "w-full rounded-md border border-gray-200 bg-gray-100 p-2 text-base font-[Poppins] text-gray-600";

  return (
    <div className="p-4 space-y-6">
      {/* Page Title */}
      <h1 className={pageTitle}>Daily Sales & Expenses</h1>

      {/* Shift Information */}
      <div>
        <h2 className={sectionHeader}>Shift Information</h2>
        <div className="grid grid-cols-3 gap-4">
          <div>
            <label className={label}>Shift Date</label>
            <input type="date" className={input} />
          </div>
          <div>
            <label className={label}>Completed By</label>
            <input
              type="text"
              className={input}
              value={completedBy}
              onChange={(e) => setCompletedBy(e.target.value)}
            />
          </div>
          <div>
            <label className={label}>Starting Cash (฿)</label>
            <input
              type="number"
              className={input}
              value={startingCash}
              onChange={(e) => setStartingCash(parseInt(e.target.value) || 0)}
            />
          </div>
        </div>
      </div>

      {/* Sales */}
      <div>
        <h2 className={sectionHeader}>Sales Information</h2>
        <div className="grid grid-cols-4 gap-4">
          <div>
            <label className={label}>Cash Sales</label>
            <input
              type="number"
              className={input}
              value={cashSales}
              onChange={(e) => setCashSales(parseInt(e.target.value) || 0)}
            />
          </div>
          <div>
            <label className={label}>QR Sales</label>
            <input
              type="number"
              className={input}
              value={qrSales}
              onChange={(e) => setQrSales(parseInt(e.target.value) || 0)}
            />
          </div>
          <div>
            <label className={label}>Grab Sales</label>
            <input
              type="number"
              className={input}
              value={grabSales}
              onChange={(e) => setGrabSales(parseInt(e.target.value) || 0)}
            />
          </div>
          <div>
            <label className={label}>Aroi Dee Sales</label>
            <input
              type="number"
              className={input}
              value={aroiDeeSales}
              onChange={(e) => setAroiDeeSales(parseInt(e.target.value) || 0)}
            />
          </div>
        </div>
        <p className="mt-2 text-base font-medium">
          Total Sales: {thb(totalSales)}
        </p>
      </div>

      {/* Expenses */}
      <div>
        <h2 className={sectionHeader}>Expenses</h2>
        <p className="text-base font-medium">
          Total Expenses: {thb(totalExpenses)}
        </p>
      </div>

      {/* Summary */}
      <div>
        <h2 className={sectionHeader}>Summary</h2>
        <p className="!text-base">Total Sales: {thb(totalSales)}</p>
        <p className="!text-base">Total Expenses: {thb(totalExpenses)}</p>
        <p className="!text-base">
          Net Position:{" "}
          <span className="font-semibold">{thb(totalSales - totalExpenses)}</span>
        </p>
      </div>

      {/* Banking */}
      <div>
        <h2 className={sectionHeader}>Banking</h2>
        <div className="grid grid-cols-3 gap-4">
          <div>
            <label className={label}>Closing Cash (฿)</label>
            <input
              type="number"
              className={input}
              value={closingCash}
              onChange={(e) => setClosingCash(parseInt(e.target.value) || 0)}
            />
            <p className="text-sm text-gray-500">
              Record only for register balancing (not in bank calc)
            </p>
          </div>
          <div>
            <label className={label}>Cash Banked (฿)</label>
            <input
              type="text"
              className={readonlyInput}
              readOnly
              value={thb(cashBanked)}
            />
            <p className="text-sm text-gray-500">
              Auto-calculated: Cash Sales − Expenses
            </p>
          </div>
          <div>
            <label className={label}>QR Transfer Amount (฿)</label>
            <input
              type="text"
              className={readonlyInput}
              readOnly
              value={thb(qrTransfer)}
            />
            <p className="text-sm text-gray-500">
              Auto-copied from QR Sales (funds go straight to bank)
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}

2. server/forms/dailySalesV2.ts
// Do not do this:
// – Do not rename, move, or split this file
// – Do not change schema, DB, or table names
// – Do not remove or alter toCents/fromCents conversions
// – Do not add any dependencies
// – Only apply exactly what is written below

import { Request, Response } from "express";
import db from "@/server/db";
import { toCents } from "@/lib/utils";

export async function createDailySalesV2(req: Request, res: Response) {
  try {
    const {
      completedBy,
      startingCash,
      cashSales,
      qrSales,
      grabSales,
      aroiDeeSales,
      expenses,
      wages,
      closingCash,
    } = req.body;

    // Calculate totals
    const totalSales =
      toCents(cashSales) +
      toCents(qrSales) +
      toCents(grabSales) +
      toCents(aroiDeeSales);

    const totalExpenses =
      (expenses || []).reduce((sum: number, e: any) => sum + toCents(e.cost), 0) +
      (wages || []).reduce((sum: number, w: any) => sum + toCents(w.amount), 0);

    // Final formula: Cash Banked = Cash Sales - Expenses
    const cashBanked = toCents(cashSales) - totalExpenses;

    const qrTransfer = toCents(qrSales);

    const payload = {
      completedBy,
      startingCash: toCents(startingCash),
      cashSales: toCents(cashSales),
      qrSales: toCents(qrSales),
      grabSales: toCents(grabSales),
      aroiDeeSales: toCents(aroiDeeSales),
      expenses,
      wages,
      closingCash: toCents(closingCash),
      totalSales,
      totalExpenses,
      cashBanked: cashBanked < 0 ? 0 : cashBanked,
      qrTransfer,
    };

    const result = await db.query(
      `INSERT INTO daily_sales_v2 (payload) VALUES ($1) RETURNING id`,
      [payload]
    );

    res.json({ ok: true, id: result.rows[0].id });
  } catch (err) {
    console.error("Daily Sales V2 create error", err);
    res.status(500).json({ ok: false, error: "Failed to create record" });
  }
}