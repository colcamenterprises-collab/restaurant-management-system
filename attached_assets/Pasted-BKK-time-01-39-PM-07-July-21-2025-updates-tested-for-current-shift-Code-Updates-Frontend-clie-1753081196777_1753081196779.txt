BKK time: 01:39 PM +07, July 21, 2025—updates tested for current shift.

Code Updates
Frontend (client/src/pages/Receipts.tsx - Replace Existing)

Changed to multiple file input, upload array, compile all for summary.
tsx

Collapse

Unwrap

Copy
import { useState } from 'react';
import { Card, CardHeader, CardContent, Button, Input } from "@/components/ui";

const Receipts = () => {
  const [files, setFiles] = useState([]);
  const [shiftDate, setShiftDate] = useState('');
  const [reportIds, setReportIds] = useState([]);
  const [compilation, setCompilation] = useState(null);

  const handleUpload = async () => {
    const formData = new FormData();
    Array.from(files).forEach(file => formData.append('files', file));
    formData.append('shiftDate', shiftDate);
    const response = await fetch('/api/receipts/upload', { method: 'POST', body: formData });
    const data = await response.json();
    setReportIds(data.ids);
  };

  const triggerCompilation = async () => {
    const response = await fetch('/api/receipts/compile', { method: 'POST', body: JSON.stringify({ reportIds }) });
    const data = await response.json();
    setCompilation(data);
  };

  return (
    <Card>
      <CardHeader>Receipts for Shift</CardHeader>
      <CardContent>
        <Input type="date" onChange={(e) => setShiftDate(e.target.value)} />
        <Input type="file" multiple onChange={(e) => setFiles(e.target.files)} />
        <Button onClick={handleUpload}>Upload Receipts</Button>
        {reportIds.length > 0 && <Button onClick={triggerCompilation}>Compile Items/Modifiers</Button>}
        {compilation && (
          <div>
            <h3>Items Sold by Category</h3>
            <ul>{compilation.items.map((item, i) => <li key={i}>{item.category}: {item.name} ({item.quantity})</li>)}</ul>
            <h3>Modifiers Sold</h3>
            <ul>{compilation.modifiers.map((mod, i) => <li key={i}>{mod.name} ({mod.count})</li>)}</ul>
            <h3>Ingredient Usage Summary</h3>
            <ul>{compilation.ingredients.map((ing, i) => <li key={i}>{ing.name}: {ing.quantity} {ing.unit}</li>)}</ul>
          </div>
        )}
      </CardContent>
    </Card>
  );
};

export default Receipts;
Backend (server/routes.ts - Update Upload/Compile)

Handle multiple files (upload.array), insert each, compile across all for shift.
typescript

Collapse

Unwrap

Run

Copy
import multer from 'multer';
import OpenAI from 'openai';
import { db } from '../db';
import { uploadedReceipts } from '../../shared/schema';
import pdfParse from 'pdf-parse';
import xlsx from 'xlsx';

const upload = multer({ memoryStorage: true });
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

// Upload multiple
app.post('/api/receipts/upload', upload.array('files', 5), async (req, res) => { // Max 5 files
  const files = req.files;
  const shiftDate = req.body.shiftDate || DateTime.now().setZone('Asia/Bangkok').toISODate();
  const ids = [];
  for (const file of files) {
    const fileData = file.buffer;
    const [report] = await db.insert(uploadedReceipts).values({
      filename: file.originalname,
      fileType: file.mimetype,
      fileData,
      shiftDate,
    }).returning({ id: uploadedReceipts.id });
    ids.push(report.id);
  }
  res.json({ ids });
});

// Compile from multiple
app.post('/api/receipts/compile', async (req, res) => {
  const reportIds = req.body.reportIds;
  let combinedText = '';
  for (const id of reportIds) {
    const report = await db.select().from(uploadedReceipts).where(eq(uploadedReceipts.id, id)).limit(1)[0];
    let text;
    if (report.fileType === 'application/pdf') {
      text = (await pdfParse(report.fileData)).text;
    } else if (report.fileType === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') {
      const workbook = xlsx.read(report.fileData, { type: 'buffer' });
      text = xlsx.utils.sheet_to_csv(workbook.Sheets[workbook.SheetNames[0]]);
    } else if (report.fileType === 'text/csv') {
      text = report.fileData.toString('utf-8');
    }
    combinedText += text + '\n';
  }

  const prompt = `Compile receipts: List items sold by category, include quantities/modifiers, calculate ingredient usage (e.g., Single Smash Burger: 1 roll, 20g butter, 1 cheese, 95g meat). JSON output: { items: [{ category: string, name: string, quantity: number }], modifiers: [{ name: string, count: number }], ingredients: [{ name: string, quantity: number, unit: string }] }.`;
  const response = await openai.chat.completions.create({ model: 'gpt-4o', messages: [{ role: 'user', content: prompt + combinedText }] });
  const compilation = JSON.parse(response.choices[0].message.content);

  // Store compilation in first report (or new table)
  await db.update(uploadedReceipts).set({ compilationSummary: compilation }).where(eq(uploadedReceipts.id, reportIds[0]));

  res.json(compilation);
});
DB Schema (shared/schema.ts - Verify/Adjust uploadedReceipts)

Add compilationSummary if not present.
typescript

Collapse

Unwrap

Run

Copy
export const uploadedReceipts = pgTable('uploaded_receipts', {
  id: serial('id').primaryKey(),
  filename: varchar('filename', { length: 255 }),
  fileType: varchar('file_type', { length: 50 }),
  fileData: bytea('file_data'),
  shiftDate: timestamp('shift_date'),
  compilationSummary: jsonb('compilation_summary'), // Stores items, modifiers, ingredients
});
Run npx drizzle-kit migrate.

Run & Verify

Install: npm i multer pdf-parse xlsx (if not).
Test: Upload multiple files (e.g., receipts.csv, sales-by-item.csv), trigger—displays combined items/modifiers/ingredients.
Check DB: SELECT compilationSummary FROM uploadedReceipts WHERE id = [id];.
This enables multi-file upload/compilation for the Receipts page. Test with your reports—share results/errors.