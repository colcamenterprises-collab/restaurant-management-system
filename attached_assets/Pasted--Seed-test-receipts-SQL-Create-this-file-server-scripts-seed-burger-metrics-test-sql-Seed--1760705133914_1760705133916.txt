) Seed test receipts (SQL)

Create this file:

server/scripts/seed_burger_metrics_test.sql

-- Seed a deterministic test shift on 2025-10-15 (18:00 -> 03:00 next day, Asia/Bangkok)
-- Assumes Postgres with JSONB available and pos_receipt referencing pos_batch(id)

-- 1) Create a test batch if it doesn't exist
INSERT INTO pos_batch (id, created_at)
VALUES ('TEST_BATCH_1', NOW())
ON CONFLICT (id) DO NOTHING;

-- 2) Clean any previous test receipts for idempotency
DELETE FROM pos_receipt WHERE batch_id = 'TEST_BATCH_1';

-- Helper: a function to construct JSON arrays is not needed; we inline JSON.

-- 3) Insert receipts within the shift window (2025-10-15 18:xx to 2025-10-16 02:xx)

-- Receipt A: 3x Single Smash Burger (‡∏ã‡∏¥‡∏á‡πÄ‡∏Å‡∏¥‡πâ‡∏•), plus a drink line
INSERT INTO pos_receipt (id, batch_id, receipt_id, datetime, total, items_json, payment, created_at)
VALUES (
  gen_random_uuid(), 'TEST_BATCH_1', 'R-A', '2025-10-15 18:10:00+07', 1000,
  '[
    {"name":"Single Smash Burger (‡∏ã‡∏¥‡∏á‡πÄ‡∏Å‡∏¥‡πâ‡∏•)", "quantity":3, "price":100},
    {"name":"Coke Can", "quantity":1, "price":30}
  ]'::jsonb,
  'Cash', NOW()
);

-- Receipt B: 2x Super Double Bacon and Cheese (‡∏ã‡∏π‡πÄ‡∏õ‡∏≠‡∏£‡πå‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡πâ‡∏•‡πÄ‡∏ö‡∏Ñ‡∏≠‡∏ô)
INSERT INTO pos_receipt (id, batch_id, receipt_id, datetime, total, items_json, payment, created_at)
VALUES (
  gen_random_uuid(), 'TEST_BATCH_1', 'R-B', '2025-10-15 19:25:00+07', 1200,
  '[
    {"name":"Super Double Bacon and Cheese (‡∏ã‡∏π‡πÄ‡∏õ‡∏≠‡∏£‡πå‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡πâ‡∏•‡πÄ‡∏ö‡∏Ñ‡∏≠‡∏ô)", "quantity":2, "price":200}
  ]'::jsonb,
  'QR', NOW()
);

-- Receipt C: 1x Triple Smash Set (Meal Deal) + a drink line
INSERT INTO pos_receipt (id, batch_id, receipt_id, datetime, total, items_json, payment, created_at)
VALUES (
  gen_random_uuid(), 'TEST_BATCH_1', 'R-C', '2025-10-15 20:05:00+07', 800,
  '[
    {"name":"Triple Smash Set (Meal Deal)", "quantity":1, "price":350},
    {"name":"Sprite Can", "quantity":1, "price":30}
  ]'::jsonb,
  'Cash', NOW()
);

-- Receipt D: 2x Crispy Chicken Fillet Burger (‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÑ‡∏Å‡πà‡∏ä‡∏¥‡πâ‡∏ô)
INSERT INTO pos_receipt (id, batch_id, receipt_id, datetime, total, items_json, payment, created_at)
VALUES (
  gen_random_uuid(), 'TEST_BATCH_1', 'R-D', '2025-10-15 21:40:00+07', 600,
  '[
    {"name":"Crispy Chicken Fillet Burger (‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÑ‡∏Å‡πà‡∏ä‡∏¥‡πâ‡∏ô)", "quantity":2, "price":150}
  ]'::jsonb,
  'Cash', NOW()
);

-- Receipt E: 4x Karaage Chicken (Meal Deal) ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÑ‡∏Å‡πà‡∏Ñ‡∏≤‡∏£‡∏≤‡∏≠‡∏≤‡πÄ‡∏Å‡∏∞ + 2 drinks
INSERT INTO pos_receipt (id, batch_id, receipt_id, datetime, total, items_json, payment, created_at)
VALUES (
  gen_random_uuid(), 'TEST_BATCH_1', 'R-E', '2025-10-15 22:55:00+07', 1800,
  '[
    {"name":"Karaage Chicken (Meal Deal) ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÑ‡∏Å‡πà‡∏Ñ‡∏≤‡∏£‡∏≤‡∏≠‡∏≤‡πÄ‡∏Å‡∏∞", "quantity":4, "price":200},
    {"name":"Coke Can", "quantity":2, "price":30}
  ]'::jsonb,
  'Card', NOW()
);

-- Receipt F: 1x Kids Single Meal Set (Burger Fries Drink)
INSERT INTO pos_receipt (id, batch_id, receipt_id, datetime, total, items_json, payment, created_at)
VALUES (
  gen_random_uuid(), 'TEST_BATCH_1', 'R-F', '2025-10-16 01:15:00+07', 300,
  '[
    {"name":"Kids Single Meal Set (Burger Fries Drink)", "quantity":1, "price":250}
  ]'::jsonb,
  'Cash', NOW()
);

> If your pos_batch table has different columns, just minimally ensure an id='TEST_BATCH_1' row exists.




---

2) One-shot seed + run script (bash)

Add an npm script and bash helper so Replit can run this in one click.

package.json (add these under "scripts")

{
  "scripts": {
    "seed:burger-test": "psql \"$DATABASE_URL\" -f server/scripts/seed_burger_metrics_test.sql",
    "test:burger-metrics": "ts-node server/scripts/run_burger_metrics_test.ts"
  }
}

Create this runner (TypeScript; uses your live server on port 5000):

server/scripts/run_burger_metrics_test.ts

/* eslint-disable no-console */
import 'dotenv/config';
import fetch from 'node-fetch';

const SERVER = process.env.SERVER_URL || 'http://localhost:5000';
const TEST_DATE = '2025-10-15'; // matches the seed window

// Expected from seeded data
const EXPECT = {
  totalBurgers: 13,
  patties: 11,
  redMeatGrams: 11 * 95,   // 1045
  chickenGrams: 600,       // 6 x 100
  rolls: 13
};

function assertEq(label: string, got: number, want: number) {
  const ok = got === want;
  console.log(`${ok ? '‚úÖ' : '‚ùå'} ${label}: got=${got} want=${want}`);
  if (!ok) throw new Error(`${label} mismatch`);
}

(async function main() {
  try {
    const url = `${SERVER}/api/receipts/shift/burgers?date=${TEST_DATE}`;
    console.log(`‚Üí GET ${url}`);
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const j = await r.json();

    if (!j.ok) throw new Error(j.error || 'Endpoint returned ok=false');

    const data = j.data as {
      shiftDate: string;
      totals: { burgers: number; patties: number; redMeatGrams: number; chickenGrams: number; rolls: number };
      products: Array<{ normalizedName: string; qty: number }>;
    };

    console.log('\n=== Products ===');
    for (const p of data.products) {
      if (p.qty > 0) console.log(`- ${p.normalizedName}: ${p.qty}`);
    }

    console.log('\n=== Totals ===');
    console.log(data.totals);

    // Assertions
    assertEq('Total Burgers', data.totals.burgers, EXPECT.totalBurgers);
    assertEq('Beef Patties', data.totals.patties, EXPECT.patties);
    assertEq('Red Meat (g)', data.totals.redMeatGrams, EXPECT.redMeatGrams);
    assertEq('Chicken (g)', data.totals.chickenGrams, EXPECT.chickenGrams);
    assertEq('Rolls', data.totals.rolls, EXPECT.rolls);

    console.log('\nüéâ TEST PASSED ‚Äî burger metrics match expected.');
    process.exit(0);
  } catch (e: any) {
    console.error('\nüí• TEST FAILED:', e?.message || e);
    process.exit(1);
  }
})();

> Requires ts-node and node-fetch in your dev deps:



npm i -D ts-node node-fetch @types/node


---

3) How to run (step-by-step)

A) Ensure server is running

Your Express server should already mount /api/receipts/shift/burgers.

If needed, start it:

npm run dev

(or whatever your start script is)


B) Seed test data

npm run seed:burger-test

This inserts receipts into the fixed shift window.

C) Run the test

npm run test:burger-metrics

You should see:

A product list with non-zero rows like:

Single Smash Burger ‚Äî 3

Super Double Bacon & Cheese ‚Äî 2

Triple Smash Burger ‚Äî 1

Crispy Chicken Fillet Burger ‚Äî 2

Karaage Chicken Burger ‚Äî 4

Kids Single Meal Set ‚Äî 1


Totals object printed

‚úÖ checks for each metric

üéâ TEST PASSED ‚Äî burger metrics match expected.


If anything differs, you‚Äôll get a ‚ùå with the mismatch and a non-zero exit code.


---
