1) Install tiny dev deps (once)

npm i -D ts-node typescript @types/node node-fetch pg

> (You already have tsx or ts-node? keep going‚Äîthis stays compatible.)




---

2) Create a universal seeder (auto-detects your table name)

server/scripts/seed_burger_metrics_universal.ts

/* eslint-disable no-console */
import 'dotenv/config';
import { Client } from 'pg';

const SHIFT_DATE = '2025-10-15'; // seed date (local Asia/Bangkok)
const TZ = '+07';                // Bangkok UTC offset

// Seed payload (same as before)
const receipts = [
  {
    id: 'R-A',
    datetime: `2025-10-15 18:10:00${TZ}`,
    items: [
      { name: 'Single Smash Burger (‡∏ã‡∏¥‡∏á‡πÄ‡∏Å‡∏¥‡πâ‡∏•)', quantity: 3, price: 100 },
      { name: 'Coke Can', quantity: 1, price: 30 },
    ],
    payment: 'Cash', total: 1000,
  },
  {
    id: 'R-B',
    datetime: `2025-10-15 19:25:00${TZ}`,
    items: [
      { name: 'Super Double Bacon and Cheese (‡∏ã‡∏π‡πÄ‡∏õ‡∏≠‡∏£‡πå‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡πâ‡∏•‡πÄ‡∏ö‡∏Ñ‡∏≠‡∏ô)', quantity: 2, price: 200 },
    ],
    payment: 'QR', total: 1200,
  },
  {
    id: 'R-C',
    datetime: `2025-10-15 20:05:00${TZ}`,
    items: [
      { name: 'Triple Smash Set (Meal Deal)', quantity: 1, price: 350 },
      { name: 'Sprite Can', quantity: 1, price: 30 },
    ],
    payment: 'Cash', total: 800,
  },
  {
    id: 'R-D',
    datetime: `2025-10-15 21:40:00${TZ}`,
    items: [
      { name: 'Crispy Chicken Fillet Burger (‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÑ‡∏Å‡πà‡∏ä‡∏¥‡πâ‡∏ô)', quantity: 2, price: 150 },
    ],
    payment: 'Cash', total: 600,
  },
  {
    id: 'R-E',
    datetime: `2025-10-15 22:55:00${TZ}`,
    items: [
      { name: 'Karaage Chicken (Meal Deal) ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÑ‡∏Å‡πà‡∏Ñ‡∏≤‡∏£‡∏≤‡∏≠‡∏≤‡πÄ‡∏Å‡∏∞', quantity: 4, price: 200 },
      { name: 'Coke Can', quantity: 2, price: 30 },
    ],
    payment: 'Card', total: 1800,
  },
  {
    id: 'R-F',
    datetime: `2025-10-16 01:15:00${TZ}`,
    items: [
      { name: 'Kids Single Meal Set (Burger Fries Drink)', quantity: 1, price: 250 },
    ],
    payment: 'Cash', total: 300,
  },
];

async function main() {
  const db = new Client({ connectionString: process.env.DATABASE_URL });
  await db.connect();

  // Detect table name/casing
  const candidates = [
    { table: 'pos_receipt', batch: 'pos_batch' },           // snake_case
    { table: '"PosReceipt"', batch: '"PosBatch"' },         // PascalCase quoted
  ];

  let target: { table: string; batch: string } | null = null;

  for (const c of candidates) {
    const res = await db.query(
      `SELECT to_regclass('public.${c.table.replace(/"/g, '')}') AS exists`
    );
    if (res.rows?.[0]?.exists) {
      target = c;
      break;
    }
  }

  if (!target) {
    console.error('üí• Could not find pos_receipt / "PosReceipt" table in public schema.');
    await db.end();
    process.exit(1);
  }

  console.log(`‚Üí Using tables: ${target.batch} / ${target.table}`);

  // Ensure test batch exists
  await db.query(`DO $$
  BEGIN
    IF NOT EXISTS (SELECT 1 FROM ${target.batch} WHERE id = 'TEST_BATCH_1') THEN
      INSERT INTO ${target.batch} (id, created_at) VALUES ('TEST_BATCH_1', NOW());
    END IF;
  END $$;`);

  // Clean previous test data
  await db.query(`DELETE FROM ${target.table} WHERE batch_id = 'TEST_BATCH_1';`);

  // Insert receipts
  for (const r of receipts) {
    await db.query(
      `INSERT INTO ${target.table} (id, batch_id, receipt_id, datetime, total, items_json, payment, created_at)
       VALUES (gen_random_uuid(), $1, $2, $3::timestamptz, $4, $5::jsonb, $6, NOW())`,
      [
        'TEST_BATCH_1',
        r.id,
        r.datetime,
        r.total,
        JSON.stringify(r.items),
        r.payment,
      ]
    );
  }

  console.log('‚úÖ Seeded 6 receipts into test shift window.');
  await db.end();
}

main().catch((e) => {
  console.error('üí• Seeder failed:', e?.message || e);
  process.exit(1);
});


---

3) Create a universal test runner (uses your running server)

server/scripts/run_burger_metrics_test.ts

/* eslint-disable no-console */
import 'dotenv/config';
import fetch from 'node-fetch';

const SERVER = process.env.SERVER_URL || 'http://localhost:5000';
const TEST_DATE = '2025-10-15';

const EXPECT = {
  burgers: 13,
  patties: 11,
  redMeatGrams: 11 * 95,  // 1045
  chickenGrams: 600,      // 6 x 100
  rolls: 13,
};

function check(label: string, got: number, want: number) {
  const ok = got === want;
  console.log(`${ok ? '‚úÖ' : '‚ùå'} ${label}: got=${got} want=${want}`);
  if (!ok) throw new Error(`${label} mismatch`);
}

(async () => {
  try {
    const url = `${SERVER}/api/receipts/shift/burgers?date=${TEST_DATE}`;
    console.log(`‚Üí GET ${url}`);
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || 'ok=false');

    const d = j.data as {
      products: Array<{ normalizedName: string; qty: number }>;
      totals: { burgers: number; patties: number; redMeatGrams: number; chickenGrams: number; rolls: number };
      fromISO: string; toISO: string; shiftDate: string;
    };

    console.log('\n=== Non-zero products ===');
    d.products.filter(p => p.qty > 0).forEach(p => console.log(`- ${p.normalizedName}: ${p.qty}`));

    console.log('\n=== Totals ===');
    console.log(d.totals);

    check('Total Burgers', d.totals.burgers, EXPECT.burgers);
    check('Beef Patties', d.totals.patties, EXPECT.patties);
    check('Red Meat (g)', d.totals.redMeatGrams, EXPECT.redMeatGrams);
    check('Chicken (g)', d.totals.chickenGrams, EXPECT.chickenGrams);
    check('Rolls', d.totals.rolls, EXPECT.rolls);

    console.log('\nüéâ TEST PASSED ‚Äî burger metrics are correct.');
    process.exit(0);
  } catch (e: any) {
    console.error('\nüí• TEST FAILED:', e?.message || e);
    process.exit(1);
  }
})();


---

4) Add NPM scripts

Add to package.json ‚Üí "scripts":

{
  "scripts": {
    "seed:burger-universal": "ts-node server/scripts/seed_burger_metrics_universal.ts",
    "test:burger-metrics": "ts-node server/scripts/run_burger_metrics_test.ts"
  }
}

(If you already have tsx, you can swap ts-node ‚Üí tsx.)


---

5) Run the verification (CLI)

1. Start your server (so the endpoint is live):



npm run dev

2. Seed test data:



npm run seed:burger-universal

3. Run test:



npm run test:burger-metrics

You should see non-zero product rows, the totals object, ‚úÖ checks, and:

üéâ TEST PASSED ‚Äî burger metrics are correct.


---

6) Quick manual checks

cURL

curl -s "http://localhost:5000/api/receipts/shift/burgers?date=2025-10-15" | jq

Confirm totals match expected above.

UI

Open:

/operations/analysis/receipts/burgers

Enter 2025-10-15 ‚Üí Load shift ‚Üí totals and per-product rows match the expected numbers.


---

7) If it fails (fast triage)

Endpoint missing ‚Üí ensure it‚Äôs mounted:

// server/routes.ts
import receiptsBurgers from "./routes/receiptsBurgers";
app.use("/api/receipts", receiptsBurgers);

0 burgers ‚Üí your catalog names must match POS names. Check these entries exist in burgerCatalog.ts:

Single Smash Burger (‡∏ã‡∏¥‡∏á‡πÄ‡∏Å‡∏¥‡πâ‡∏•)

Super Double Bacon and Cheese (‡∏ã‡∏π‡πÄ‡∏õ‡∏≠‡∏£‡πå‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡πâ‡∏•‡πÄ‡∏ö‡∏Ñ‡∏≠‡∏ô)

Triple Smash Set (Meal Deal)

Crispy Chicken Fillet Burger (‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÑ‡∏Å‡πà‡∏ä‡∏¥‡πâ‡∏ô)

Karaage Chicken (Meal Deal) ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÑ‡∏Å‡πà‡∏Ñ‡∏≤‡∏£‡∏≤‡∏≠‡∏≤‡πÄ‡∏Å‡∏∞

Kids Single Meal Set (Burger Fries Drink)


DB table not found ‚Üí the seeder prints which table it picked; if neither exists, create pos_receipt per your schema or point the service to your live receipts table.



---

8) Cleanup (optional)

-- run in psql
DELETE FROM pos_receipt  WHERE batch_id = 'TEST_BATCH_1';
DELETE FROM "PosReceipt" WHERE batch_id = 'TEST_BATCH_1';

DELETE FROM pos_batch  WHERE id = 'TEST_BATCH_1';
DELETE FROM "PosBatch" WHERE id = 'TEST_BATCH_1';


---

9) Definition of Done (use this checklist)

[ ] /api/receipts/shift/burgers?date=2025-10-15 returns totals: 13 / 11 / 1045g / 600g / 13

[ ] UI page shows same totals and rows

[ ] npm run test:burger-metrics prints TEST PASSED

[ ] CSV export from UI matches totals

