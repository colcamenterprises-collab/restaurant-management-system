Agent Instructions — Fix Daily Sales Save + Library + Hooks

Goal: When the user submits the Daily Sales & Stock form, a record is saved and appears in Daily Sales Library. Also trigger the follow-up hooks (email + shopping list) from the same save point.

We will add a safe V2 pipeline that does not fight existing code. Everything is idempotent and backed up.

0) Run this EXACT shell script
bash -lc 'set -euo pipefail

echo "▶ Creating backup…"
mkdir -p backups
cp -a server routes.ts 2>/dev/null || true
cp -a src/server/routes.ts backups/routes.ts.$(date +%s) 2>/dev/null || true

echo "▶ Ensuring dirs…"
mkdir -p src/server/forms
mkdir -p scripts

echo "▶ Writing new V2 Daily Sales router…"
cat > src/server/forms/dailySalesV2.ts << "EOF"
import express from "express";
import type { Request, Response } from "express";

// We try Prisma first (preferred). If not present, we fallback to direct SQL.
let prisma: any = null;
try { prisma = require("../../prisma").prisma || require("../prisma").prisma; } catch { /* ignore */ }

import { Pool } from "pg";
const pool = new Pool({ connectionString: process.env.DATABASE_URL });

/** Ensure a raw capture table exists so we never lose submissions
 *  NOTE: This does NOT replace the real typed table. It guarantees persistence.
 */
async function ensureTable() {
  await pool.query(`
    CREATE TABLE IF NOT EXISTS daily_sales_v2 (
      id BIGSERIAL PRIMARY KEY,
      created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
      staff TEXT,
      shift_date DATE,
      payload JSONB NOT NULL
    );
    CREATE INDEX IF NOT EXISTS idx_daily_sales_v2_date ON daily_sales_v2(shift_date);
  `);
}
ensureTable().catch(console.error);

export const dailySalesV2Router = express.Router();

/** POST /api/forms/daily-sales/v2
 *  Body: the full form payload. We store it raw + a few top-level fields.
 */
dailySalesV2Router.post("/daily-sales/v2", async (req: Request, res: Response) => {
  try {
    const body = req.body || {};
    const staff = body?.staffName || body?.staff || null;

    // try Prisma typed create if a model exists, else raw JSON bucket
    if (prisma?.dailySales) {
      const created = await prisma.dailySales.create({ data: body });
      // Hooks after successful save
      queueHooksSafely(created);
      return res.json({ ok: true, id: created?.id, record: created });
    } else {
      const shiftDate = body?.shiftDate || body?.date || null;
      const result = await pool.query(
        `INSERT INTO daily_sales_v2 (staff, shift_date, payload)
         VALUES ($1, $2, $3) RETURNING id, created_at`,
        [staff, shiftDate, JSON.stringify(body)]
      );
      const created = { id: result.rows[0].id, createdAt: result.rows[0].created_at, staff, shiftDate, payload: body };
      queueHooksSafely(created);
      return res.json({ ok: true, id: created.id, record: created });
    }
  } catch (err:any) {
    console.error("Daily Sales Save Error:", err);
    return res.status(500).json({ ok:false, error: err?.message || "save_failed" });
  }
});

/** GET /api/forms/daily-sales/v2
 *  Returns 100 most recent submissions for the Library table.
 */
dailySalesV2Router.get("/daily-sales/v2", async (_req: Request, res: Response) => {
  try {
    if (prisma?.dailySales) {
      const rows = await prisma.dailySales.findMany({ orderBy: { createdAt: "desc" }, take: 100 });
      return res.json({ ok: true, rows });
    } else {
      const r = await pool.query(
        `SELECT id, created_at as "createdAt", staff, shift_date as "shiftDate", payload
         FROM daily_sales_v2 ORDER BY id DESC LIMIT 100`
      );
      return res.json({ ok: true, rows: r.rows });
    }
  } catch (err:any) {
    console.error("Daily Sales List Error:", err);
    return res.status(500).json({ ok:false, error: err?.message || "list_failed" });
  }
});

/** Fire-and-forget hooks: email + shopping list.
 *  We do not throw if these fail; persistence already succeeded.
 */
function queueHooksSafely(record: any) {
  try {
    // Prefer existing services if present; otherwise no-op.
    try {
      const mailer = require("../services/mailer");
      if (mailer?.sendDailySalesSummary) mailer.sendDailySalesSummary(record);
    } catch {}
    try {
      const purchasing = require("../services/purchasing");
      if (purchasing?.generateShoppingListFromDailySales) purchasing.generateShoppingListFromDailySales(record);
    } catch {}
  } catch (e) {
    console.warn("DailySales hooks failed (non-blocking):", e);
  }
}
EOF

echo "▶ Registering router in server…"
# Insert import and use() in src/server/routes.ts without breaking existing routes
# 1) add import if missing
grep -q "dailySalesV2Router" src/server/routes.ts || \
sed -i.bak '1i import { dailySalesV2Router } from "./forms/dailySalesV2";' src/server/routes.ts

# 2) mount under existing Forms routes block, or add a safe mount near other app.use lines
if ! grep -q "/api/forms\", dailySalesV2Router" src/server/routes.ts; then
  sed -i.bak \
  "s#// Register Forms routes#// Register Forms routes\napp.use(\"/api/forms\", dailySalesV2Router);#g" \
  src/server/routes.ts
fi

echo \"▶ Frontend: point form submit + library to the new V2 endpoints…\"
# These are safe broad replacements; if nothing matches, it is a no-op.
grep -Rsl \"api/daily-sales\" client src 2>/dev/null | xargs -I{} sed -i.bak \"s#api/daily-sales#api/forms/daily-sales/v2#g\" {} || true
grep -Rsl \"api/forms/daily-sales\" client src 2>/dev/null | xargs -I{} sed -i.bak \"s#api/forms/daily-sales#api/forms/daily-sales/v2#g\" {} || true

echo \"▶ Build and restart…\"
npm run build >/dev/null 2>&1 || true
npm run start >/dev/null 2>&1 & sleep 2

echo \"▶ Smoke tests…\"
# 1) create a fake submission
curl -s -X POST http://localhost:5000/api/forms/daily-sales/v2 \
  -H \"Content-Type: application/json\" \
  -d '{\"shiftDate\":\"2025-08-27\",\"staffName\":\"Test Staff\",\"cashStart\":0,\"cashEnd\":0,\"totalSales\":0,\"notes\":\"health check\"}' | head -c 200; echo
# 2) list it back
curl -s http://localhost:5000/api/forms/daily-sales/v2 | head -c 200; echo

echo \"✅ Daily Sales V2 pipeline installed.\"
'


This creates a safe V2 API (/api/forms/daily-sales/v2) that always persists the form (Prisma if available, JSON bucket if not), lists into the Library, and triggers hooks after the save.

1) What this changes (summary)

Backend

New file: src/server/forms/dailySalesV2.ts

New endpoints:

POST /api/forms/daily-sales/v2 → saves submission

GET /api/forms/daily-sales/v2 → lists recent submissions

Router auto-registered in src/server/routes.ts

Database

Creates a guaranteed JSON capture table: daily_sales_v2 (if a typed Prisma model isn’t ready or is drifting).

If prisma.dailySales model exists, it uses that instead.

Hooks

Tries to call services/mailer.sendDailySalesSummary(record) and
services/purchasing.generateShoppingListFromDailySales(record) if they exist (non-blocking).

Frontend

Any call found to api/daily-sales or api/forms/daily-sales is rewritten to /api/forms/daily-sales/v2 (form submit + library fetch).

2) Acceptance tests (run exactly)

Submit a fake record

curl -s -X POST http://localhost:5000/api/forms/daily-sales/v2 \
  -H "Content-Type: application/json" \
  -d '{"shiftDate":"2025-08-27","staffName":"Health Check","cashStart":0,"cashEnd":0,"totalSales":0}' | jq .


Expect: { ok: true, id: <number>, record: { … } }

List in Library API

curl -s http://localhost:5000/api/forms/daily-sales/v2 | jq .


Expect: { ok: true, rows: [ … latest submission … ] }

UI

Hard refresh (Cmd/Ctrl+Shift+R) on:

Daily Sales & Stock → submit a real entry

Daily Sales Library → new record appears

3) Notes / guardrails

Do not touch existing V1 logic; the V2 path is additive and safe.

If the library page still fetches the old endpoint, the sed step missed it—run a targeted replace in the page:

Replace any fetch("/api/daily-sales or fetch("/api/forms/daily-sales with fetch("/api/forms/daily-sales/v2".

If Prisma model is later stabilized, the V2 route will automatically start using it (it already tries Prisma first).

4) Rollback

backups/routes.ts.<timestamp> contains the previous routes.ts.

Remove src/server/forms/dailySalesV2.ts, revert the import and app.use(...) line, then restart.