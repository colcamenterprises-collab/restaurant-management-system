Backend Fix Patch â€“ Jussi Generate & Shift Report Integration
--- server/services/summaryGenerator.js
- import { db } from "../db/client";
- import { dailyReceiptSummaries, daily_sales_v2, expenses, recipes } from "../db/schema";
- import { getLoyverseReceipts, getShiftReport } from "../utils/loyverse";
+ import { db } from "../db/client";
+ import { dailyReceiptSummaries } from "../db/schema";
+ import { daily_sales_v2 } from "../db/schema";   // âœ… use correct export name
+ import { expenses } from "../db/schema";
+ import { recipes } from "../db/schema";
+ import { getLoyverseReceipts, getShiftReport } from "../utils/loyverse";

 export async function generateJussiReport(date) {
-   const receipts = await getLoyverseReceipts({ date });
-   const shift = await getShiftReport({ date });
-   const form = await db.query.daily_sales_v2.findFirst({ where: (t, { eq }) => eq(t.date, date) });
-   const purchases = await db.query.expenses.findMany({ where: (t, { eq }) => eq(t.date, date) });
-   const recipeList = await db.query.recipes.findMany();
+   // âœ… Pull all sources of truth
+   const receipts = await getLoyverseReceipts({ date });
+   const shiftReport = await getShiftReport({ date });   // Gross, Net, Grab, QR, Direct, Expenses
+   const form = await db.query.daily_sales_v2.findFirst({
+     where: (t, { eq }) => eq(t.date, date),
+   });
+   const purchases = await db.query.expenses.findMany({
+     where: (t, { eq }) => eq(t.date, date),
+   });
+   const recipeList = await db.query.recipes.findMany();

-   // Build OpenAI prompt
-   const prompt = `
-   You are Jussi, Head of Ops. Analyze data for shift ${date}.
-   Inputs:
-   - Receipts: ${JSON.stringify(receipts)}
-   - Shift Report: ${JSON.stringify(shift)}
-   - Staff Form: ${JSON.stringify(form)}
-   - Purchases: ${JSON.stringify(purchases)}
-   - Recipes: ${JSON.stringify(recipeList)}
-
-   Tasks:
-   1. Sales vs POS: Compare staff form totals (gross, net, grab, qr, direct, expenses) vs shift report. Flag any mismatch.
-   2. Stock Usage:
-      - Rolls: Expected = Start + Purchases â€“ BurgersSold. Flag if variance < -4 or > +4.
-      - Meat: 90g per patty. Flag if variance > 500g.
-      - Drinks: 1 per sale. Flag if variance > 2 units.
-   3. Basket of Goods: Count burgers, side orders, modifiers sold.
-   4. Ingredient Breakdown: For each menu item sold, calculate expected ingredient usage based on recipes. Return totals.
-   5. Top 5 Items Sold (by qty).
-   6. Payment Breakdown: Total by cash, qr, grab, direct.
-   7. Flags: List all anomalies clearly.
-   `;
+   // âœ… Build OpenAI prompt including shift report for variance check
+   const prompt = `
+   You are Jussi, Head of Ops. Analyze shift ${date}.
+   Inputs:
+   - POS Shift Report: ${JSON.stringify(shiftReport)}
+   - Receipts: ${JSON.stringify(receipts)}
+   - Staff Form: ${JSON.stringify(form)}
+   - Purchases: ${JSON.stringify(purchases)}
+   - Recipes: ${JSON.stringify(recipeList)}
+
+   Tasks:
+   1. Sales vs POS: Compare staff form totals (gross, net, grab, qr, direct, expenses) vs shift report totals. Flag mismatches.
+   2. Stock Usage:
+      - Rolls: Expected = Start + Purchases â€“ BurgersSold. ðŸš¨ Flag if variance < -4 or > +4.
+      - Meat: 90g per patty. ðŸš¨ Flag if variance > 500g.
+      - Drinks: 1 per sale. ðŸš¨ Flag if variance > 2 units.
+   3. Basket of Goods: Count burgers, side orders, modifiers sold from receipts.
+   4. Ingredient Breakdown: For each menu item sold, calculate expected ingredient usage using recipes.
+   5. Top 5 Items Sold (by qty).
+   6. Payment Breakdown: Split by cash, qr, grab, direct.
+   7. Flags: Summarise anomalies clearly.
+
+   Output JSON ONLY:
+   {
+     salesVsPOS: [{field, formValue, posValue, status}],
+     stockUsage: [{item, expected, actual, variance, status}],
+     basketBreakdown: {burgers, sides, modifiers},
+     ingredientUsage: [{ingredient, expected, actual, variance, status}],
+     top5Items: [{item, qty}],
+     paymentBreakdown: [{method, amount}],
+     flags: [ "..." ]
+   }
+   `;

   const resp = await openai.chat.completions.create({
     model: "gpt-4o",
     messages: [{ role: "system", content: "You are Jussi, operations AI." }, { role: "user", content: prompt }],
   });

   const data = JSON.parse(resp.choices[0].message.content);

-   await db.insert(dailyReceiptSummaries).values({ shiftDate: date, data })
-     .onConflictDoUpdate({ target: dailyReceiptSummaries.shiftDate, set: { data } });
+   // âœ… Save into DB with upsert
+   await db.insert(dailyReceiptSummaries)
+     .values({ shiftDate: date, data })
+     .onConflictDoUpdate({
+       target: dailyReceiptSummaries.shiftDate,
+       set: { data },
+     });

   return data;
 }