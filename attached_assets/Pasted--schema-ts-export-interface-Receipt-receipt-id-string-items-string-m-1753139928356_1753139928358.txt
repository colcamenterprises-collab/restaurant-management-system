// ===== schema.ts =====
export interface Receipt {
  receipt_id: string;
  items: string[];
  modifiers: string[];
  total: number;
  timestamp: string;
  payment_type?: string;
  net_sales?: number;
  gross_sales?: number;
  discounts?: number;
  taxes?: number;
}

export interface Expense {
  date: string;
  category: string;
  amount: number;
  notes?: string;
}

export interface StockEntry {
  rolls: number;
  meat: number;
  drinks: number;
}

export interface TaskPayload {
  receipts?: Receipt[];
  expenses?: Expense[];
  stock?: StockEntry;
  notes?: string;
  dateRange?: { start: string; end: string };
}

// ===== utils/gptUtils.ts =====
import { config } from "dotenv";
import OpenAI from "openai";
import winston from "winston";
config();

const logger = winston.createLogger({
  transports: [
    new winston.transports.Console(),
    new winston.transports.File({ filename: 'logs/gpt.log' })
  ]
});

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

export async function askGPT(prompt: string): Promise<string> {
  try {
    const response = await openai.chat.completions.create({
      model: "gpt-4o",
      messages: [{ role: "user", content: prompt }],
    });
    return response.choices[0].message.content || "";
  } catch (err) {
    logger.error(`GPT error: ${err.message}`);
    return "GPT error";
  }
}

// ===== agents/boss_agent.ts =====
import { askGPT } from "../utils/gptUtils";
import { TaskPayload } from "../schema";

export async function runBossAgent(task: string, data: TaskPayload) {
  if (task === "chat") {
    return await askGPT(`
You are Big Boss, the company director overseeing Sally, Ollie, and Marlo.
Respond with authority, fairness, and wit.

The user said: "${data.notes}"

Return a short and decisive reply. If this is about team behaviour or internal issues, include a directive to resolve it.
`);
  }
  return "Unknown boss task.";
}

// ===== manager/agent_manager.ts (append or modify this section) =====
import { runBossAgent } from "../agents/boss_agent";

export async function runAgentManager(task: string, payload: TaskPayload) {
  switch (task) {
    case "CHAT_OLLIE":
      return await runOperationsAgent("chat", payload);
    case "CHAT_SALLY":
      return await runFinanceAgent("chat", payload);
    case "CHAT_MARLO":
      return await runContentAgent("chat", payload);
    case "CHAT_BIGBOSS":
      return await runBossAgent("chat", payload);
    default:
      return { status: "error", message: "Unknown task type." };
  }
}

// ===== index.ts (append to /chat/:agentName route) =====
app.post("/chat/:agentName", async (req, res) => {
  const { agentName } = req.params;
  const { message } = req.body;

  const agentMap: Record<string, string> = {
    ollie: "CHAT_OLLIE",
    sally: "CHAT_SALLY",
    marlo: "CHAT_MARLO",
    bigboss: "CHAT_BIGBOSS",
  };

  const taskType = agentMap[agentName.toLowerCase()];
  if (!taskType) {
    return res.status(404).json({ error: "Agent not found." });
  }

  const result = await runAgentManager(taskType, { notes: message });
  res.json({ reply: result });
});
