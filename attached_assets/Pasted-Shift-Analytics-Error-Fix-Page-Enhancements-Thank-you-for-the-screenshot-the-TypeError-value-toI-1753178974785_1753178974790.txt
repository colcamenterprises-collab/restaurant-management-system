Shift Analytics Error Fix & Page Enhancements
Thank you for the screenshot—the "TypeError: value.toISOString is not a function" in Shift Analytics is a date conversion issue (likely string vs. Date object in shiftDate). We'll fix it by adding robust date parsing (new Date(value)). We'll also address your points: merge Receipts and AI Analysis into one super Analysis page (upload reports, compile items/modifiers/ingredients, prominent chat box with AI agent for daily tasks), remove Loyverse-specific titles (generic "Receipts Upload" for multi-POS), fix Critical Stock runtime (likely array/map error—add check), make Stock vs Purchased historical (from DB, not live), add AI agent instructions (daily: analyze receipts, flag anomalies, calc usage, gen report). This keeps data accuracy (date fixes, DB queries), simple (merged page), sleek/minimal (shadcn cards, chat embedded), secure (direct API/DB), direct (OpenAI for agent, no 3rd party). Growth-ready (add agent tasks).

BKK time: 01:39 PM +07, July 21, 2025—shiftDate uses Luxon.

1. Fix Shift Analysis Error (server/routes.ts - Update /api/shift-analysis)
Add date conversion.

typescript

Collapse

Unwrap

Run

Copy
app.get('/api/shift-analysis', async (req, res) => {
  try {
    const shiftDate = req.query.shiftDate ? new Date(req.query.shiftDate) : DateTime.now().setZone('Asia/Bangkok').minus({ days: 1 }).toJSDate();
    const form = await db.select().from(dailyStockSales).where(eq(dailyStockSales.shiftDate, shiftDate)).limit(1)[0];
    if (!form) return res.json({ message: 'No analytics for ' + shiftDate.toISOString() });
    // ...analysis logic
    res.json(form);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});
Test: GET /api/shift-analysis?shiftDate=2025-07-21—expect JSON without error.

Merge Receipts & AI Analysis into One Page (client/src/pages/Analysis.tsx - Replace Existing)
Sleek card with upload, compile button, chat box for AI agent (daily tasks: analyze receipts, flag anomalies, calc usage, gen report).

tsx

Collapse

Unwrap

Copy
import { useState } from 'react';
import { Card, CardHeader, CardContent, Button, Input, Textarea } from "@/components/ui";

const Analysis = () => {
  const [file, setFile] = useState(null);
  const [shiftDate, setShiftDate] = useState('');
  const [reportId, setReportId] = useState(null);
  const [compilation, setCompilation] = useState(null);
  const [message, setMessage] = useState('');
  const [chatResponse, setChatResponse] = useState('');

  const handleUpload = async () => {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('shiftDate', shiftDate);
    const response = await fetch('/api/receipts/upload', { method: 'POST', body: formData });
    const data = await response.json();
    setReportId(data.id);
  };

  const triggerCompilation = async () => {
    const response = await fetch('/api/receipts/compile', { method: 'POST', body: JSON.stringify({ reportId }) });
    const data = await response.json();
    setCompilation(data);
  };

  const chatWithAgent = async () => {
    const response = await fetch('/api/ai-analysis', { method: 'POST', body: JSON.stringify({ message, reportId }) });
    const data = await response.json();
    setChatResponse(data.response);
  };

  return (
    <Card>
      <CardHeader>Analysis</CardHeader>
      <CardContent>
        <Input type="date" onChange={(e) => setShiftDate(e.target.value)} />
        <Input type="file" onChange={(e) => setFile(e.target.files[0])} />
        <Button onClick={handleUpload}>Upload Receipts</Button>
        {reportId && <Button onClick={triggerCompilation}>Compile Items/Modifiers</Button>}
        {compilation && <pre>{JSON.stringify(compilation, null, 2)}</pre>}
        <h3>Chat with AI Agent</h3>
        <Textarea placeholder="Ask about receipts (e.g., 'Analyze anomalies')" onChange={(e) => setMessage(e.target.value)} />
        <Button onClick={chatWithAgent}>Send</Button>
        {chatResponse && <p>Agent: {chatResponse}</p>}
      </CardContent>
    </Card>
  );
};

export default Analysis;
Backend (server/routes.ts - Add /api/ai-analysis)

typescript

Collapse

Unwrap

Run

Copy
app.post('/api/ai-analysis', async (req, res) => {
  const { message, reportId } = req.body;
  const report = await db.select().from(uploadedReceipts).where(eq(uploadedReceipts.id, reportId)).limit(1)[0];
  const prompt = `Daily AI agent task: Analyze receipts for items/modifiers/usage, flag anomalies, calc ingredients. User query: ${message}. Data: ${JSON.stringify(report)}`;
  const response = await openai.chat.completions.create({ model: 'gpt-4o', messages: [{ role: 'user', content: prompt }] });
  res.json({ response: response.choices[0].message.content });
});
Sidebar (client/src/components/Sidebar.tsx - Merge Receipts/AI)
Remove separate Receipts/AI—keep "AI Analysis" linking to /ops-sales/ai-analysis (merged page).

typescript

Collapse

Unwrap

Run

Copy
// In menuItems Ops & Sales subs
{ label: 'AI Analysis', path: '/ops-sales/ai-analysis' }, // Merged Receipts
Fix Critical Stock Runtime (client/src/pages/CriticalStock.tsx - Update Existing)

Add checks for arrays/maps.
tsx

Collapse

Unwrap

Copy
const CriticalStock = () => {
  const [stock, setStock] = useState([]);
  useEffect(() => {
    fetch('/api/stock').then(r => r.json()).then(setStock);
  }, []);

  return (
    <Card>
      <CardHeader>Critical Stock</CardHeader>
      <CardContent>
        <Table>
          <TableBody>
            {Array.isArray(stock) && stock.map((item, i) => (
              <TableRow key={i}>
                <TableCell>{item.name}</TableCell>
                <TableCell>{item.quantity}</TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </CardContent>
    </Card>
  );
};
Backend (server/routes.ts - Update /api/stock)
typescript

Collapse

Unwrap

Run

Copy
app.get('/api/stock', async (req, res) => {
  const stock = await db.select().from(inventory);
  res.json(stock || []);
});